{"file":"C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\utils\\encryption.utils.ts","mappings":"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","names":[],"sources":["C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\utils\\encryption.utils.ts"],"sourcesContent":["import crypto from 'crypto';\n\n/**\n * SECURITY: Encryption utilities for sensitive data (PII)\n * Uses AES-256-GCM for authenticated encryption\n *\n * Environment Variable Required:\n * ENCRYPTION_KEY - 32-byte hex string (generated via: openssl rand -hex 32)\n */\n\nconst ENCRYPTION_KEY = process.env.ENCRYPTION_KEY;\nconst ALGORITHM = 'aes-256-gcm';\nconst SALT_LENGTH = 16; // 128 bits\nconst TAG_LENGTH = 16;  // 128 bits for GCM authentication tag\n\n// Validate encryption key at startup\nif (!ENCRYPTION_KEY) {\n  throw new Error('ENCRYPTION_KEY environment variable is required for data encryption');\n}\n\nif (ENCRYPTION_KEY.length !== 64) {\n  throw new Error('ENCRYPTION_KEY must be 32 bytes (64 hex characters)');\n}\n\n// Type assertion - validated above\nconst KEY = ENCRYPTION_KEY as string;\n\n/**\n * Encrypt sensitive data using AES-256-GCM\n * Returns: iv:salt:encrypted:tag in hex format\n */\nexport function encrypt(plaintext: string): string {\n  try {\n    // Generate random IV (initialization vector) - 12 bytes for GCM\n    const iv = crypto.randomBytes(12);\n\n    // Generate random salt - for additional security\n    const salt = crypto.randomBytes(SALT_LENGTH);\n\n    // Create cipher\n    const cipher = crypto.createCipheriv(\n      ALGORITHM,\n      Buffer.from(KEY, 'hex'),\n      iv\n    );\n\n    // Encrypt\n    const encrypted = Buffer.concat([\n      cipher.update(plaintext, 'utf8'),\n      cipher.final()\n    ]);\n\n    // Get authentication tag (proves data hasn't been tampered with)\n    const tag = cipher.getAuthTag();\n\n    // Return format: iv:salt:encrypted:tag (all hex)\n    return `${iv.toString('hex')}:${salt.toString('hex')}:${encrypted.toString('hex')}:${tag.toString('hex')}`;\n  } catch (error) {\n    throw new Error(`Encryption failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Decrypt encrypted data using AES-256-GCM\n * Input format: iv:salt:encrypted:tag (hex)\n */\nexport function decrypt(encryptedData: string): string {\n  try {\n    const parts = encryptedData.split(':');\n    if (parts.length !== 4) {\n      throw new Error('Invalid encrypted data format');\n    }\n\n    const iv = Buffer.from(parts[0], 'hex');\n    const salt = Buffer.from(parts[1], 'hex');\n    const encrypted = Buffer.from(parts[2], 'hex');\n    const tag = Buffer.from(parts[3], 'hex');\n\n    // Validate sizes\n    if (iv.length !== 12) throw new Error('Invalid IV size');\n    if (tag.length !== TAG_LENGTH) throw new Error('Invalid authentication tag size');\n\n    // Create decipher\n    const decipher = crypto.createDecipheriv(\n      ALGORITHM,\n      Buffer.from(KEY, 'hex'),\n      iv\n    );\n\n    // Set authentication tag (for verification)\n    decipher.setAuthTag(tag);\n\n    // Decrypt\n    const decrypted = Buffer.concat([\n      decipher.update(encrypted),\n      decipher.final()\n    ]);\n\n    return decrypted.toString('utf8');\n  } catch (error) {\n    throw new Error(`Decryption failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Generate hash of sensitive data for searchable field\n * Uses HMAC-SHA256 for consistency\n */\nexport function hashForSearch(plaintext: string): string {\n  return crypto\n    .createHmac('sha256', KEY)\n    .update(plaintext)\n    .digest('hex');\n}\n\n/**\n * Verify if plaintext matches hash\n */\nexport function verifyHashForSearch(plaintext: string, hash: string): boolean {\n  const computed = hashForSearch(plaintext);\n  // Use constant-time comparison to prevent timing attacks\n  return crypto.timingSafeEqual(\n    Buffer.from(computed),\n    Buffer.from(hash)\n  );\n}\n\n/**\n * Safely decrypt phone number, handling both encrypted and plain text formats\n * Some records may have plain text phones (legacy data before encryption was added)\n * Returns the decrypted phone if encrypted, or the original phone if already plain text\n */\nexport function decryptPhoneSafe(phoneData: string): string {\n  try {\n    // Check if it looks encrypted: format is iv:salt:encrypted:tag (4 parts separated by colons)\n    const parts = phoneData.split(':');\n    if (parts.length === 4) {\n      // Try to decrypt assuming it's in encrypted format\n      return decrypt(phoneData);\n    }\n\n    // Not encrypted - return as-is (plain text phone like +12064664353)\n    return phoneData;\n  } catch (error) {\n    // If decryption fails for any reason, assume it's plain text\n    return phoneData;\n  }\n}\n\n/**\n * Safely decrypt email, handling both encrypted and plain text formats\n * Some records may have plain text emails (legacy data before encryption was added)\n * Returns the decrypted email if encrypted, or the original email if already plain text\n */\nexport function decryptEmailSafe(emailData: string): string {\n  try {\n    // Check if it looks encrypted: format is iv:salt:encrypted:tag (4 parts separated by colons)\n    const parts = emailData.split(':');\n    if (parts.length === 4) {\n      // Try to decrypt assuming it's in encrypted format\n      return decrypt(emailData);\n    }\n\n    // Not encrypted - return as-is (plain text email like user@example.com)\n    return emailData;\n  } catch (error) {\n    // If decryption fails for any reason, assume it's plain text\n    return emailData;\n  }\n}\n\n/**\n * Generate token for various purposes (invitations, password resets, etc)\n */\nexport function generateToken(lengthBytes: number = 32): string {\n  return crypto.randomBytes(lengthBytes).toString('hex');\n}\n\n/**\n * Create HMAC signature for webhook verification\n */\nexport function createSignature(message: string, secret: string): string {\n  return crypto\n    .createHmac('sha256', secret)\n    .update(message)\n    .digest('hex');\n}\n\n/**\n * Verify HMAC signature with constant-time comparison\n */\nexport function verifySignature(message: string, signature: string, secret: string): boolean {\n  try {\n    const expectedSignature = createSignature(message, secret);\n    return crypto.timingSafeEqual(\n      Buffer.from(signature),\n      Buffer.from(expectedSignature)\n    );\n  } catch {\n    return false;\n  }\n}\n"],"version":3}