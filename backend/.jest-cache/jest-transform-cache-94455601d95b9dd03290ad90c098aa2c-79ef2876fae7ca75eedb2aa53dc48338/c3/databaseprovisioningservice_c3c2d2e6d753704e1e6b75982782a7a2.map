{"file":"C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\database-provisioning.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\database-provisioning.service.ts"],"sourcesContent":["/**\n * Database Provisioning Service\n *\n * Handles creation and management of per-tenant databases\n * Each tenant (church) gets its own isolated PostgreSQL database\n */\n\nimport { PrismaClient } from '@prisma/client';\n\n/**\n * Provision a new tenant database\n * Creates a new database on the PostgreSQL server and returns the connection string\n */\nexport async function provisionTenantDatabase(tenantId: string): Promise<string> {\n  try {\n    const databaseName = `tenant_${tenantId}`;\n\n    // Parse the base database URL from environment\n    const baseUrl = process.env.DATABASE_URL || '';\n    if (!baseUrl) {\n      throw new Error('DATABASE_URL not configured');\n    }\n\n    // Extract connection details from base URL\n    // Format: postgresql://user:password@host:port/database\n    const urlMatch = baseUrl.match(/postgresql:\\/\\/([^:]+):([^@]+)@([^:]+):(\\d+)/);\n    if (!urlMatch) {\n      throw new Error('Invalid DATABASE_URL format');\n    }\n\n    const [, user, password, host, port] = urlMatch;\n\n    // Create a admin connection to the server to create the new database\n    const adminUrl = `postgresql://${user}:${password}@${host}:${port}/postgres`;\n    const adminPrisma = new PrismaClient({\n      datasources: {\n        db: { url: adminUrl },\n      },\n    });\n\n    try {\n      // Create the database\n      // Note: Using raw SQL since Prisma doesn't support DDL operations like CREATE DATABASE\n      await adminPrisma.$executeRawUnsafe(\n        `CREATE DATABASE \"${databaseName}\" ENCODING 'UTF8'`\n      );\n\n      console.log(`✅ Tenant database created: ${databaseName}`);\n\n      // Return the connection string for the new database\n      const tenantUrl = `postgresql://${user}:${password}@${host}:${port}/${databaseName}`;\n      return tenantUrl;\n    } finally {\n      await adminPrisma.$disconnect();\n    }\n  } catch (error: any) {\n    // Check if database already exists (which is fine)\n    if (error.message?.includes('already exists')) {\n      console.log(`ℹ️ Tenant database already exists: tenant_${tenantId}`);\n      const baseUrl = process.env.DATABASE_URL || '';\n      const urlMatch = baseUrl.match(/postgresql:\\/\\/([^:]+):([^@]+)@([^:]+):(\\d+)/);\n      if (urlMatch) {\n        const [, user, password, host, port] = urlMatch;\n        return `postgresql://${user}:${password}@${host}:${port}/tenant_${tenantId}`;\n      }\n    }\n\n    console.error('Failed to provision tenant database:', error);\n    throw new Error(`Database provisioning failed: ${error.message}`);\n  }\n}\n\n/**\n * Run Prisma migrations on a tenant database\n * Applies the tenant schema to the newly created database\n * Uses Prisma db push to apply the tenant-schema.prisma to the database\n */\nexport async function runTenantMigrations(tenantDatabaseUrl: string): Promise<void> {\n  try {\n    // Create a temporary Prisma client for this database to verify connection\n    const tempPrisma = new PrismaClient({\n      datasources: {\n        db: { url: tenantDatabaseUrl },\n      },\n    });\n\n    try {\n      // Verify connection works\n      await tempPrisma.$executeRaw`SELECT 1`;\n      console.log('✅ Tenant database connection verified');\n    } finally {\n      await tempPrisma.$disconnect();\n    }\n\n    // Run prisma db push with tenant schema to initialize all tables\n    // This applies the tenant-schema.prisma to the database\n    const { execSync } = require('child_process');\n    const path = require('path');\n\n    try {\n      console.log('⏳ Running Prisma migrations (tenant schema)...');\n\n      // Set environment variable for Prisma to use tenant database\n      const env = {\n        ...process.env,\n        TENANT_DATABASE_URL: tenantDatabaseUrl,\n        NODE_ENV: process.env.NODE_ENV || 'development',\n      };\n\n      // Run prisma db push with tenant schema\n      // This will create all tables from tenant-schema.prisma\n      execSync(\n        'npx prisma db push --schema=prisma/tenant-schema.prisma --skip-generate',\n        {\n          env,\n          stdio: 'pipe', // Capture output to avoid cluttering logs\n          cwd: process.cwd(),\n        }\n      );\n\n      console.log('✅ Tenant schema migrations completed');\n    } catch (execError: any) {\n      // Log the actual error output\n      const errorMessage = execError.stderr?.toString() || execError.stdout?.toString() || execError.message;\n      console.error('Migration command output:', errorMessage);\n      throw new Error(`Prisma migrations failed: ${errorMessage}`);\n    }\n  } catch (error: any) {\n    console.error('Failed to run tenant migrations:', error);\n    throw new Error(`Migration failed: ${error.message}`);\n  }\n}\n\n/**\n * Delete a tenant database (soft delete - archive instead)\n * DANGER: This operation is irreversible\n */\nexport async function deleteTenantDatabase(tenantId: string): Promise<void> {\n  try {\n    const databaseName = `tenant_${tenantId}`;\n\n    // Parse the base database URL from environment\n    const baseUrl = process.env.DATABASE_URL || '';\n    if (!baseUrl) {\n      throw new Error('DATABASE_URL not configured');\n    }\n\n    // Extract connection details from base URL\n    const urlMatch = baseUrl.match(/postgresql:\\/\\/([^:]+):([^@]+)@([^:]+):(\\d+)/);\n    if (!urlMatch) {\n      throw new Error('Invalid DATABASE_URL format');\n    }\n\n    const [, user, password, host, port] = urlMatch;\n\n    // Create a admin connection to drop the database\n    const adminUrl = `postgresql://${user}:${password}@${host}:${port}/postgres`;\n    const adminPrisma = new PrismaClient({\n      datasources: {\n        db: { url: adminUrl },\n      },\n    });\n\n    try {\n      // Terminate all connections to the database before dropping\n      await adminPrisma.$executeRawUnsafe(`\n        SELECT pg_terminate_backend(pg_stat_activity.pid)\n        FROM pg_stat_activity\n        WHERE pg_stat_activity.datname = '${databaseName}'\n        AND pid <> pg_backend_pid();\n      `);\n\n      // Drop the database\n      await adminPrisma.$executeRawUnsafe(`DROP DATABASE IF EXISTS \"${databaseName}\"`);\n\n      console.log(`✅ Tenant database deleted: ${databaseName}`);\n    } finally {\n      await adminPrisma.$disconnect();\n    }\n  } catch (error: any) {\n    console.error('Failed to delete tenant database:', error);\n    throw new Error(`Database deletion failed: ${error.message}`);\n  }\n}\n\n/**\n * Check if a tenant database exists\n */\nexport async function tenantDatabaseExists(tenantId: string): Promise<boolean> {\n  try {\n    const databaseName = `tenant_${tenantId}`;\n\n    // Parse the base database URL from environment\n    const baseUrl = process.env.DATABASE_URL || '';\n    if (!baseUrl) {\n      throw new Error('DATABASE_URL not configured');\n    }\n\n    // Extract connection details from base URL\n    const urlMatch = baseUrl.match(/postgresql:\\/\\/([^:]+):([^@]+)@([^:]+):(\\d+)/);\n    if (!urlMatch) {\n      throw new Error('Invalid DATABASE_URL format');\n    }\n\n    const [, user, password, host, port] = urlMatch;\n\n    // Create a admin connection to check the database\n    const adminUrl = `postgresql://${user}:${password}@${host}:${port}/postgres`;\n    const adminPrisma = new PrismaClient({\n      datasources: {\n        db: { url: adminUrl },\n      },\n    });\n\n    try {\n      const result = await adminPrisma.$queryRaw<Array<{ exists: boolean }>>`\n        SELECT EXISTS(SELECT 1 FROM pg_database WHERE datname = ${databaseName});\n      `;\n\n      return result[0]?.exists || false;\n    } finally {\n      await adminPrisma.$disconnect();\n    }\n  } catch (error: any) {\n    console.error('Failed to check if tenant database exists:', error);\n    return false;\n  }\n}\n"],"version":3}