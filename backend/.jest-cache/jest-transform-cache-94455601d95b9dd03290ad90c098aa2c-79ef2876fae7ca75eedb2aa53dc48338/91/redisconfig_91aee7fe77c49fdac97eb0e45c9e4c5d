62d011d1be039953d98b2465b51d948a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.redisClient = void 0;
exports.connectRedis = connectRedis;
exports.disconnectRedis = disconnectRedis;
const redis_1 = require("redis");
const redisUrl = process.env.REDIS_URL || 'redis://localhost:6379';
exports.redisClient = (0, redis_1.createClient)({
    url: redisUrl,
    // Auto-reconnect configuration to handle connection drops
    socket: {
        reconnectStrategy: (retries) => {
            // Reconnect immediately first 3 times, then with exponential backoff
            if (retries < 3) {
                return 0; // Retry immediately
            }
            const delayMs = Math.min(1000 * Math.pow(2, retries - 3), 30000); // Max 30 seconds
            console.log(`üîÑ Redis reconnect attempt ${retries}, waiting ${delayMs}ms`);
            return delayMs;
        },
        // Connection timeout and keepalive
        connectTimeout: 10000,
        keepAlive: 30000,
    },
});
exports.redisClient.on('error', (err) => {
    console.error('‚ùå Redis Client Error:', err.message);
});
exports.redisClient.on('connect', () => {
    console.log('‚úÖ Redis connected');
});
exports.redisClient.on('ready', () => {
    console.log('‚úÖ Redis ready to use');
});
exports.redisClient.on('reconnecting', () => {
    console.log('üîÑ Redis reconnecting...');
});
// Koinonia to Redis with timeout
async function connectRedis(timeoutMs = 10000) {
    if (exports.redisClient.isOpen) {
        return true; // Already connected
    }
    return new Promise((resolve) => {
        let connected = false;
        const timeout = setTimeout(() => {
            if (!connected) {
                console.error('‚ùå Redis connection timeout after', timeoutMs, 'ms');
                console.error('   Using fallback mode: Token revocation will be less reliable');
                console.error('   Check REDIS_URL environment variable or Redis service status');
                resolve(false); // Resolve as failed but don't throw - app can continue
            }
        }, timeoutMs);
        exports.redisClient.connect()
            .then(() => {
            connected = true;
            clearTimeout(timeout);
            console.log('‚úÖ Redis connection established successfully');
            resolve(true);
        })
            .catch((error) => {
            connected = true;
            clearTimeout(timeout);
            console.error('‚ùå Redis connection failed:', error.message);
            console.error('   Using fallback mode: Token revocation disabled');
            console.error('   Ensure REDIS_URL is set to a valid Redis instance');
            resolve(false); // Continue without Redis
        });
    });
}
async function disconnectRedis() {
    if (exports.redisClient.isOpen) {
        try {
            await exports.redisClient.disconnect();
            console.log('‚úÖ Redis connection closed gracefully');
        }
        catch (error) {
            console.error('‚ö†Ô∏è  Error disconnecting Redis:', error.message);
        }
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxXaW5kb3dzXFxPbmVEcml2ZSAtIFNlYXR0bGUgQ29sbGVnZXNcXERlc2t0b3BcXFlXTUVTU0FHSU5HXFxiYWNrZW5kXFxzcmNcXGNvbmZpZ1xccmVkaXMuY29uZmlnLnRzIiwibWFwcGluZ3MiOiI7OztBQXdDQSxvQ0FnQ0M7QUFFRCwwQ0FTQztBQW5GRCxpQ0FBcUM7QUFFckMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksd0JBQXdCLENBQUM7QUFFdEQsUUFBQSxXQUFXLEdBQUcsSUFBQSxvQkFBWSxFQUFDO0lBQ3RDLEdBQUcsRUFBRSxRQUFRO0lBQ2IsMERBQTBEO0lBQzFELE1BQU0sRUFBRTtRQUNOLGlCQUFpQixFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUU7WUFDckMscUVBQXFFO1lBQ3JFLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNoQixPQUFPLENBQUMsQ0FBQyxDQUFDLG9CQUFvQjtZQUNoQyxDQUFDO1lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsaUJBQWlCO1lBQ25GLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLE9BQU8sYUFBYSxPQUFPLElBQUksQ0FBQyxDQUFDO1lBQzNFLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxtQ0FBbUM7UUFDbkMsY0FBYyxFQUFFLEtBQUs7UUFDckIsU0FBUyxFQUFFLEtBQUs7S0FDakI7Q0FDRixDQUFDLENBQUM7QUFFSCxtQkFBVyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtJQUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0RCxDQUFDLENBQUMsQ0FBQztBQUVILG1CQUFXLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7SUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ25DLENBQUMsQ0FBQyxDQUFDO0FBRUgsbUJBQVcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtJQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDdEMsQ0FBQyxDQUFDLENBQUM7QUFFSCxtQkFBVyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUMxQyxDQUFDLENBQUMsQ0FBQztBQUVILGlDQUFpQztBQUMxQixLQUFLLFVBQVUsWUFBWSxDQUFDLFlBQW9CLEtBQUs7SUFDMUQsSUFBSSxtQkFBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLENBQUMsb0JBQW9CO0lBQ25DLENBQUM7SUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7UUFDN0IsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNuRSxPQUFPLENBQUMsS0FBSyxDQUFDLGdFQUFnRSxDQUFDLENBQUM7Z0JBQ2hGLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUVBQWlFLENBQUMsQ0FBQztnQkFDakYsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsdURBQXVEO1lBQ3pFLENBQUM7UUFDSCxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFZCxtQkFBVyxDQUFDLE9BQU8sRUFBRTthQUNsQixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1QsU0FBUyxHQUFHLElBQUksQ0FBQztZQUNqQixZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1lBQzNELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFVLEVBQUUsRUFBRTtZQUNwQixTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN0QixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMzRCxPQUFPLENBQUMsS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7WUFDbkUsT0FBTyxDQUFDLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLHlCQUF5QjtRQUMzQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVNLEtBQUssVUFBVSxlQUFlO0lBQ25DLElBQUksbUJBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUM7WUFDSCxNQUFNLG1CQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2pFLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFdpbmRvd3NcXE9uZURyaXZlIC0gU2VhdHRsZSBDb2xsZWdlc1xcRGVza3RvcFxcWVdNRVNTQUdJTkdcXGJhY2tlbmRcXHNyY1xcY29uZmlnXFxyZWRpcy5jb25maWcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAncmVkaXMnO1xuXG5jb25zdCByZWRpc1VybCA9IHByb2Nlc3MuZW52LlJFRElTX1VSTCB8fCAncmVkaXM6Ly9sb2NhbGhvc3Q6NjM3OSc7XG5cbmV4cG9ydCBjb25zdCByZWRpc0NsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gIHVybDogcmVkaXNVcmwsXG4gIC8vIEF1dG8tcmVjb25uZWN0IGNvbmZpZ3VyYXRpb24gdG8gaGFuZGxlIGNvbm5lY3Rpb24gZHJvcHNcbiAgc29ja2V0OiB7XG4gICAgcmVjb25uZWN0U3RyYXRlZ3k6IChyZXRyaWVzOiBudW1iZXIpID0+IHtcbiAgICAgIC8vIFJlY29ubmVjdCBpbW1lZGlhdGVseSBmaXJzdCAzIHRpbWVzLCB0aGVuIHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxuICAgICAgaWYgKHJldHJpZXMgPCAzKSB7XG4gICAgICAgIHJldHVybiAwOyAvLyBSZXRyeSBpbW1lZGlhdGVseVxuICAgICAgfVxuICAgICAgY29uc3QgZGVsYXlNcyA9IE1hdGgubWluKDEwMDAgKiBNYXRoLnBvdygyLCByZXRyaWVzIC0gMyksIDMwMDAwKTsgLy8gTWF4IDMwIHNlY29uZHNcbiAgICAgIGNvbnNvbGUubG9nKGDwn5SEIFJlZGlzIHJlY29ubmVjdCBhdHRlbXB0ICR7cmV0cmllc30sIHdhaXRpbmcgJHtkZWxheU1zfW1zYCk7XG4gICAgICByZXR1cm4gZGVsYXlNcztcbiAgICB9LFxuICAgIC8vIENvbm5lY3Rpb24gdGltZW91dCBhbmQga2VlcGFsaXZlXG4gICAgY29ubmVjdFRpbWVvdXQ6IDEwMDAwLFxuICAgIGtlZXBBbGl2ZTogMzAwMDAsXG4gIH0sXG59KTtcblxucmVkaXNDbGllbnQub24oJ2Vycm9yJywgKGVycjogYW55KSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoJ+KdjCBSZWRpcyBDbGllbnQgRXJyb3I6JywgZXJyLm1lc3NhZ2UpO1xufSk7XG5cbnJlZGlzQ2xpZW50Lm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICBjb25zb2xlLmxvZygn4pyFIFJlZGlzIGNvbm5lY3RlZCcpO1xufSk7XG5cbnJlZGlzQ2xpZW50Lm9uKCdyZWFkeScsICgpID0+IHtcbiAgY29uc29sZS5sb2coJ+KchSBSZWRpcyByZWFkeSB0byB1c2UnKTtcbn0pO1xuXG5yZWRpc0NsaWVudC5vbigncmVjb25uZWN0aW5nJywgKCkgPT4ge1xuICBjb25zb2xlLmxvZygn8J+UhCBSZWRpcyByZWNvbm5lY3RpbmcuLi4nKTtcbn0pO1xuXG4vLyBLb2lub25pYSB0byBSZWRpcyB3aXRoIHRpbWVvdXRcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb25uZWN0UmVkaXModGltZW91dE1zOiBudW1iZXIgPSAxMDAwMCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBpZiAocmVkaXNDbGllbnQuaXNPcGVuKSB7XG4gICAgcmV0dXJuIHRydWU7IC8vIEFscmVhZHkgY29ubmVjdGVkXG4gIH1cblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBsZXQgY29ubmVjdGVkID0gZmFsc2U7XG4gICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKCFjb25uZWN0ZWQpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFJlZGlzIGNvbm5lY3Rpb24gdGltZW91dCBhZnRlcicsIHRpbWVvdXRNcywgJ21zJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyAgIFVzaW5nIGZhbGxiYWNrIG1vZGU6IFRva2VuIHJldm9jYXRpb24gd2lsbCBiZSBsZXNzIHJlbGlhYmxlJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyAgIENoZWNrIFJFRElTX1VSTCBlbnZpcm9ubWVudCB2YXJpYWJsZSBvciBSZWRpcyBzZXJ2aWNlIHN0YXR1cycpO1xuICAgICAgICByZXNvbHZlKGZhbHNlKTsgLy8gUmVzb2x2ZSBhcyBmYWlsZWQgYnV0IGRvbid0IHRocm93IC0gYXBwIGNhbiBjb250aW51ZVxuICAgICAgfVxuICAgIH0sIHRpbWVvdXRNcyk7XG5cbiAgICByZWRpc0NsaWVudC5jb25uZWN0KClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICBjb25zb2xlLmxvZygn4pyFIFJlZGlzIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgIGNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFJlZGlzIGNvbm5lY3Rpb24gZmFpbGVkOicsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCcgICBVc2luZyBmYWxsYmFjayBtb2RlOiBUb2tlbiByZXZvY2F0aW9uIGRpc2FibGVkJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyAgIEVuc3VyZSBSRURJU19VUkwgaXMgc2V0IHRvIGEgdmFsaWQgUmVkaXMgaW5zdGFuY2UnKTtcbiAgICAgICAgcmVzb2x2ZShmYWxzZSk7IC8vIENvbnRpbnVlIHdpdGhvdXQgUmVkaXNcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRpc2Nvbm5lY3RSZWRpcygpIHtcbiAgaWYgKHJlZGlzQ2xpZW50LmlzT3Blbikge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZWRpc0NsaWVudC5kaXNjb25uZWN0KCk7XG4gICAgICBjb25zb2xlLmxvZygn4pyFIFJlZGlzIGNvbm5lY3Rpb24gY2xvc2VkIGdyYWNlZnVsbHknKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfimqDvuI8gIEVycm9yIGRpc2Nvbm5lY3RpbmcgUmVkaXM6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=