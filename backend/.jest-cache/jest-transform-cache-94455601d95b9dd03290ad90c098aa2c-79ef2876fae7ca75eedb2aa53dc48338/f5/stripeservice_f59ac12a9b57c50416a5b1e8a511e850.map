{"file":"C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\stripe.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\stripe.service.ts"],"sourcesContent":["import Stripe from 'stripe';\n\nconst STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY;\n\nif (!STRIPE_SECRET_KEY) {\n  throw new Error('STRIPE_SECRET_KEY environment variable is required');\n}\n\nconst stripe = new Stripe(STRIPE_SECRET_KEY, {\n  apiVersion: '2022-11-15',\n});\n\n/**\n * Create a Stripe customer\n */\nexport async function createCustomer(email: string, name: string): Promise<string> {\n  try {\n    const customer = await stripe.customers.create({\n      email,\n      name,\n      description: `Church: ${name}`,\n    });\n\n    console.log(`✅ Stripe customer created: ${customer.id}`);\n    return customer.id;\n  } catch (error) {\n    console.error('❌ Failed to create Stripe customer:', error);\n    throw error;\n  }\n}\n\n/**\n * Create a subscription\n */\nexport async function createSubscription(\n  customerId: string,\n  priceId: string,\n  paymentMethodId?: string\n): Promise<string> {\n  try {\n    const subscriptionParams: any = {\n      customer: customerId,\n      items: [{ price: priceId }],\n    };\n\n    if (paymentMethodId) {\n      subscriptionParams.default_payment_method = paymentMethodId;\n    }\n\n    const subscription = await stripe.subscriptions.create(subscriptionParams);\n    console.log(`✅ Subscription created: ${subscription.id}`);\n    return subscription.id;\n  } catch (error) {\n    console.error('❌ Failed to create subscription:', error);\n    throw error;\n  }\n}\n\n/**\n * Update a subscription\n */\nexport async function updateSubscription(\n  subscriptionId: string,\n  newPriceId: string\n): Promise<string> {\n  try {\n    const subscription = await stripe.subscriptions.retrieve(subscriptionId);\n\n    // Get the subscription item to update\n    const subscriptionItem = subscription.items.data[0];\n\n    const updated = await stripe.subscriptionItems.update(subscriptionItem.id, {\n      price: newPriceId,\n    });\n\n    console.log(`✅ Subscription updated: ${subscriptionId}`);\n    return subscriptionId;\n  } catch (error) {\n    console.error('❌ Failed to update subscription:', error);\n    throw error;\n  }\n}\n\n/**\n * Cancel a subscription\n */\nexport async function cancelSubscription(subscriptionId: string): Promise<void> {\n  try {\n    await stripe.subscriptions.del(subscriptionId);\n    console.log(`✅ Subscription cancelled: ${subscriptionId}`);\n  } catch (error) {\n    console.error('❌ Failed to cancel subscription:', error);\n    throw error;\n  }\n}\n\n/**\n * Get customer by ID\n */\nexport async function getCustomer(customerId: string): Promise<Stripe.Customer | null> {\n  try {\n    const customer = await stripe.customers.retrieve(customerId);\n    // Handle deleted customers\n    if ('deleted' in customer && customer.deleted) {\n      return null;\n    }\n    return customer as Stripe.Customer;\n  } catch (error) {\n    console.error('❌ Failed to get customer:', error);\n    return null;\n  }\n}\n\n/**\n * Create a payment intent for one-time charges (e.g., phone number setup fee)\n * $0.50 charged to customer (Stripe minimum)\n */\nexport async function createPhoneNumberSetupPaymentIntent(\n  customerId: string,\n  phoneNumber: string\n): Promise<{ clientSecret: string; paymentIntentId: string }> {\n  try {\n    const amountInCents = 50; // $0.50 in cents (Stripe minimum)\n\n    // Use idempotency key to prevent duplicate charges\n    // Include amount in key so different amounts get different keys\n    const idempotencyKey = `phone_setup_${customerId}_${phoneNumber}_${amountInCents}`;\n\n    const paymentIntent = await stripe.paymentIntents.create(\n      {\n        amount: amountInCents,\n        currency: 'usd',\n        customer: customerId,\n        description: `Phone number setup fee for ${phoneNumber}`,\n        metadata: {\n          phoneNumber,\n          type: 'phone_number_setup',\n          telnyxFee: 100, // $1.00 goes to Telnyx\n        },\n      },\n      {\n        idempotencyKey,\n      }\n    );\n\n    console.log(`✅ Payment intent created: ${paymentIntent.id}`);\n    return {\n      clientSecret: paymentIntent.client_secret || '',\n      paymentIntentId: paymentIntent.id,\n    };\n  } catch (error: any) {\n    console.error('❌ Failed to create payment intent:', {\n      message: error.message,\n      code: error.code,\n      statusCode: error.statusCode,\n      type: error.type,\n      param: error.param,\n      stripeError: error.raw?.message,\n    });\n    throw new Error(`Stripe error: ${error.message || 'Failed to create payment intent'}`);\n  }\n}\n\n/**\n * Verify a payment intent belongs to a customer and was successful\n */\nexport async function verifyPaymentIntent(\n  paymentIntentId: string,\n  customerId: string,\n  expectedAmount: number,\n  phoneNumber: string\n): Promise<boolean> {\n  try {\n    const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\n\n    // Verify payment intent belongs to the correct customer\n    if (paymentIntent.customer !== customerId) {\n      console.error(`⚠️ Payment intent customer mismatch: expected ${customerId}, got ${paymentIntent.customer}`);\n      return false;\n    }\n\n    // Verify payment was successful\n    if (paymentIntent.status !== 'succeeded') {\n      console.error(`⚠️ Payment intent not successful: ${paymentIntent.status}`);\n      return false;\n    }\n\n    // Verify correct amount\n    if (paymentIntent.amount !== expectedAmount) {\n      console.error(`⚠️ Payment amount mismatch: expected ${expectedAmount}, got ${paymentIntent.amount}`);\n      return false;\n    }\n\n    // Verify phone number matches\n    if (paymentIntent.metadata?.phoneNumber !== phoneNumber) {\n      console.error(`⚠️ Phone number mismatch in payment intent metadata`);\n      return false;\n    }\n\n    // Verify payment intent type\n    if (paymentIntent.metadata?.type !== 'phone_number_setup') {\n      console.error(`⚠️ Invalid payment intent type: ${paymentIntent.metadata?.type}`);\n      return false;\n    }\n\n    console.log(`✅ Payment intent verified: ${paymentIntentId}`);\n    return true;\n  } catch (error) {\n    console.error('❌ Failed to verify payment intent:', error);\n    return false;\n  }\n}\n\n/**\n * Confirm a payment intent (for one-time charges)\n */\nexport async function confirmPaymentIntent(\n  paymentIntentId: string,\n  paymentMethodId: string\n): Promise<boolean> {\n  try {\n    const paymentIntent = await stripe.paymentIntents.confirm(paymentIntentId, {\n      payment_method: paymentMethodId,\n    });\n\n    if (paymentIntent.status === 'succeeded') {\n      console.log(`✅ Payment succeeded: ${paymentIntentId}`);\n      return true;\n    } else if (paymentIntent.status === 'requires_action') {\n      console.log(`⚠️ Payment requires additional action: ${paymentIntentId}`);\n      return false;\n    }\n\n    console.log(`❌ Payment failed with status: ${paymentIntent.status}`);\n    return false;\n  } catch (error) {\n    console.error('❌ Failed to confirm payment intent:', error);\n    throw error;\n  }\n}\n"],"version":3}