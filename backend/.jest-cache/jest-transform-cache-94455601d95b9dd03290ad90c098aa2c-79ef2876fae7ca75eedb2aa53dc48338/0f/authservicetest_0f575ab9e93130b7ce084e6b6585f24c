f2f3de12e258153038c4fbcad268ec4f
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
// Mock dependencies
globals_1.jest.mock('../../lib/tenant-prisma.js');
globals_1.jest.mock('../../services/database-provisioning.service.js');
globals_1.jest.mock('../../services/stripe.service.js');
globals_1.jest.mock('../../services/cache.service.js');
globals_1.jest.mock('../../utils/password.utils.js');
globals_1.jest.mock('../../utils/jwt.utils.js');
// Set up required environment variables before importing modules that check them
process.env.JWT_ACCESS_SECRET = 'test_access_secret_key_32_chars_minimum';
process.env.JWT_REFRESH_SECRET = 'test_refresh_secret_key_32_chars_minimum';
process.env.DATABASE_URL = 'postgresql://test:test@localhost/test';
const authService = __importStar(require("../../services/auth.service.js"));
const passwordUtils = __importStar(require("../../utils/password.utils.js"));
const jwtUtils = __importStar(require("../../utils/jwt.utils.js"));
const stripeService = __importStar(require("../../services/stripe.service.js"));
const cacheService = __importStar(require("../../services/cache.service.js"));
const tenantPrismaLib = __importStar(require("../../lib/tenant-prisma.js"));
const databaseProvisioningService = __importStar(require("../../services/database-provisioning.service.js"));
(0, globals_1.describe)('Authentication Service - Unit Tests', () => {
    const mockTenantId = 'church-456';
    // Tenant-level admin (no churchId in tenant schema)
    const mockTenantAdmin = {
        id: 'admin-123',
        email: 'pastor@church.com',
        encryptedEmail: 'encrypted_email',
        emailHash: 'email_hash',
        passwordHash: '$2b$10$hashedPassword123',
        firstName: 'John',
        lastName: 'Doe',
        role: 'PRIMARY',
        welcomeCompleted: false,
        userRole: 'admin',
        lastLoginAt: new Date('2024-01-01'),
    };
    // Registry-level church
    const mockChurch = {
        id: mockTenantId,
        name: 'Grace Church',
        email: 'pastor@church.com',
        stripeCustomerId: 'cus_123',
        trialEndsAt: new Date('2024-02-01'),
        subscriptionStatus: 'trial',
    };
    // Mock Prisma clients
    const mockRegistryPrisma = {
        church: {
            findFirst: globals_1.jest.fn(),
            create: globals_1.jest.fn(),
            update: globals_1.jest.fn(),
        },
        tenant: {
            create: globals_1.jest.fn(),
        },
        adminEmailIndex: {
            create: globals_1.jest.fn(),
        },
    };
    const mockTenantPrisma = {
        admin: {
            create: globals_1.jest.fn(),
            findFirst: globals_1.jest.fn(),
            findUnique: globals_1.jest.fn(),
            update: globals_1.jest.fn(),
        },
    };
    (0, globals_1.beforeEach)(() => {
        globals_1.jest.clearAllMocks();
        tenantPrismaLib.getRegistryPrisma.mockReturnValue(mockRegistryPrisma);
        tenantPrismaLib.getTenantPrisma.mockResolvedValue(mockTenantPrisma);
    });
    (0, globals_1.describe)('registerChurch', () => {
        (0, globals_1.it)('should register a new church successfully', async () => {
            const registerInput = {
                email: 'newpastor@church.com',
                password: 'SecurePass123!',
                firstName: 'Jane',
                lastName: 'Smith',
                churchName: 'New Grace Church',
            };
            // Mock password hashing
            const hashedPassword = '$2b$10$newHashedPassword';
            passwordUtils.hashPassword.mockResolvedValue(hashedPassword);
            // Mock Stripe customer creation
            const stripeCustomerId = 'cus_stripe_new';
            stripeService.createCustomer.mockResolvedValue(stripeCustomerId);
            // Mock database provisioning
            const tenantDatabaseUrl = 'postgresql://user:pass@host/tenant_db_new';
            databaseProvisioningService.provisionTenantDatabase.mockResolvedValue(tenantDatabaseUrl);
            databaseProvisioningService.runTenantMigrations.mockResolvedValue(undefined);
            // Mock registry Prisma calls
            mockRegistryPrisma.church.findFirst.mockResolvedValue(null);
            mockRegistryPrisma.church.create.mockResolvedValue(mockChurch);
            mockRegistryPrisma.tenant.create.mockResolvedValue({ id: mockTenantId });
            mockRegistryPrisma.adminEmailIndex.create.mockResolvedValue({});
            // Mock tenant Prisma calls
            mockTenantPrisma.admin.create.mockResolvedValue({
                ...mockTenantAdmin,
                email: registerInput.email,
                firstName: registerInput.firstName,
                lastName: registerInput.lastName,
            });
            mockTenantPrisma.admin.update.mockResolvedValue(mockTenantAdmin);
            // Mock token generation
            jwtUtils.generateAccessToken.mockReturnValue('access_token_123');
            jwtUtils.generateRefreshToken.mockReturnValue('refresh_token_123');
            // Execute
            const result = await authService.registerChurch(registerInput);
            // Assert
            (0, globals_1.expect)(result).toBeDefined();
            (0, globals_1.expect)(result.tenantId).toBe(mockTenantId);
            (0, globals_1.expect)(result.admin.email).toBe(registerInput.email);
            (0, globals_1.expect)(passwordUtils.hashPassword).toHaveBeenCalledWith(registerInput.password);
            (0, globals_1.expect)(stripeService.createCustomer).toHaveBeenCalled();
        });
        (0, globals_1.it)('should prevent registration with existing email', async () => {
            const registerInput = {
                email: 'existing@church.com',
                password: 'SecurePass123!',
                firstName: 'John',
                lastName: 'Doe',
                churchName: 'Existing Church',
            };
            // Mock existing church
            mockRegistryPrisma.church.findFirst.mockResolvedValue(mockChurch);
            // Execute & Assert
            await (0, globals_1.expect)(authService.registerChurch(registerInput)).rejects.toThrow();
            (0, globals_1.expect)(mockRegistryPrisma.church.findFirst).toHaveBeenCalled();
        });
    });
    (0, globals_1.describe)('login', () => {
        (0, globals_1.it)('should login successfully with correct credentials', async () => {
            const loginInput = {
                email: mockTenantAdmin.email,
                password: 'SecurePass123!',
            };
            // Mock registry church lookup
            mockRegistryPrisma.church.findFirst.mockResolvedValue(mockChurch);
            // Mock tenant admin lookup
            mockTenantPrisma.admin.findFirst.mockResolvedValue(mockTenantAdmin);
            // Mock password verification
            passwordUtils.comparePassword.mockResolvedValue(true);
            // Mock token generation
            jwtUtils.generateAccessToken.mockReturnValue('access_token_123');
            jwtUtils.generateRefreshToken.mockReturnValue('refresh_token_123');
            // Mock cache invalidation
            cacheService.invalidateCache.mockResolvedValue(undefined);
            // Mock lastLoginAt update
            mockTenantPrisma.admin.update.mockResolvedValue(mockTenantAdmin);
            // Execute
            const result = await authService.login(loginInput);
            // Assert
            (0, globals_1.expect)(result).toBeDefined();
            (0, globals_1.expect)(result.adminId).toBe(mockTenantAdmin.id);
            (0, globals_1.expect)(result.tenantId).toBe(mockTenantId);
            (0, globals_1.expect)(passwordUtils.comparePassword).toHaveBeenCalledWith(loginInput.password, mockTenantAdmin.passwordHash);
            (0, globals_1.expect)(mockTenantPrisma.admin.update).toHaveBeenCalled();
        });
        (0, globals_1.it)('should reject login with incorrect password', async () => {
            const loginInput = {
                email: mockTenantAdmin.email,
                password: 'WrongPassword123!',
            };
            // Mock registry church lookup
            mockRegistryPrisma.church.findFirst.mockResolvedValue(mockChurch);
            // Mock tenant admin lookup
            mockTenantPrisma.admin.findFirst.mockResolvedValue(mockTenantAdmin);
            // Mock password verification (fail)
            passwordUtils.comparePassword.mockResolvedValue(false);
            // Execute & Assert
            await (0, globals_1.expect)(authService.login(loginInput)).rejects.toThrow('Invalid email or password');
        });
        (0, globals_1.it)('should reject login with non-existent email', async () => {
            const loginInput = {
                email: 'nonexistent@church.com',
                password: 'SecurePass123!',
            };
            // Mock church not found
            mockRegistryPrisma.church.findFirst.mockResolvedValue(null);
            // Execute & Assert
            await (0, globals_1.expect)(authService.login(loginInput)).rejects.toThrow('Invalid email or password');
        });
    });
    (0, globals_1.describe)('refreshAccessToken', () => {
        (0, globals_1.it)('should refresh tokens successfully', async () => {
            const adminId = mockTenantAdmin.id;
            // Mock tenant admin lookup
            mockTenantPrisma.admin.findUnique.mockResolvedValue(mockTenantAdmin);
            // Mock token generation
            jwtUtils.generateAccessToken.mockReturnValue('new_access_token');
            jwtUtils.generateRefreshToken.mockReturnValue('new_refresh_token');
            // Execute
            const result = await authService.refreshAccessToken(adminId, mockTenantId);
            // Assert
            (0, globals_1.expect)(result).toBeDefined();
            (0, globals_1.expect)(result.accessToken).toBe('new_access_token');
            (0, globals_1.expect)(result.refreshToken).toBe('new_refresh_token');
            (0, globals_1.expect)(jwtUtils.generateAccessToken).toHaveBeenCalledWith(adminId, mockTenantId, mockTenantAdmin.role);
        });
        (0, globals_1.it)('should throw error if admin not found', async () => {
            const adminId = 'nonexistent-admin';
            // Mock tenant admin not found
            mockTenantPrisma.admin.findUnique.mockResolvedValue(null);
            // Execute & Assert
            await (0, globals_1.expect)(authService.refreshAccessToken(adminId, mockTenantId)).rejects.toThrow('Admin not found');
        });
    });
    (0, globals_1.describe)('getAdmin', () => {
        (0, globals_1.it)('should retrieve admin from cache if available', async () => {
            const adminId = mockTenantAdmin.id;
            const cachedAdmin = {
                ...mockTenantAdmin,
                tenantId: mockTenantId,
            };
            // Mock cache hit
            cacheService.getCached.mockResolvedValue(cachedAdmin);
            // Execute
            const result = await authService.getAdmin(adminId, mockTenantId);
            // Assert
            (0, globals_1.expect)(result).toEqual(cachedAdmin);
            (0, globals_1.expect)(mockTenantPrisma.admin.findUnique).not.toHaveBeenCalled();
        });
        (0, globals_1.it)('should fetch admin from database if not cached', async () => {
            const adminId = mockTenantAdmin.id;
            // Mock cache miss
            cacheService.getCached.mockResolvedValue(null);
            // Mock tenant Prisma call
            mockTenantPrisma.admin.findUnique.mockResolvedValue(mockTenantAdmin);
            // Mock cache set
            cacheService.setCached.mockResolvedValue(undefined);
            // Execute
            const result = await authService.getAdmin(adminId, mockTenantId);
            // Assert
            (0, globals_1.expect)(result).toBeDefined();
            (0, globals_1.expect)(result.id).toBe(adminId);
            (0, globals_1.expect)(mockTenantPrisma.admin.findUnique).toHaveBeenCalledWith({
                where: { id: adminId },
            });
            (0, globals_1.expect)(cacheService.setCached).toHaveBeenCalled();
        });
        (0, globals_1.it)('should return null if admin not found', async () => {
            const adminId = 'nonexistent-admin';
            // Mock cache miss
            cacheService.getCached.mockResolvedValue(null);
            // Mock tenant Prisma call (not found)
            mockTenantPrisma.admin.findUnique.mockResolvedValue(null);
            // Execute
            const result = await authService.getAdmin(adminId, mockTenantId);
            // Assert
            (0, globals_1.expect)(result).toBeNull();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxXaW5kb3dzXFxPbmVEcml2ZSAtIFNlYXR0bGUgQ29sbGVnZXNcXERlc2t0b3BcXFlXTUVTU0FHSU5HXFxiYWNrZW5kXFxzcmNcXF9fdGVzdHNfX1xcc2VydmljZXNcXGF1dGguc2VydmljZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWtGO0FBZWxGLG9CQUFvQjtBQUNwQixjQUFJLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLENBQUM7QUFDeEMsY0FBSSxDQUFDLElBQUksQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO0FBQzdELGNBQUksQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztBQUM5QyxjQUFJLENBQUMsSUFBSSxDQUFDLGlDQUFpQyxDQUFDLENBQUM7QUFDN0MsY0FBSSxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQzNDLGNBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQW5CdEMsaUZBQWlGO0FBQ2pGLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcseUNBQXlDLENBQUM7QUFDMUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRywwQ0FBMEMsQ0FBQztBQUM1RSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyx1Q0FBdUMsQ0FBQztBQUVuRSw0RUFBOEQ7QUFDOUQsNkVBQStEO0FBQy9ELG1FQUFxRDtBQUNyRCxnRkFBa0U7QUFDbEUsOEVBQWdFO0FBQ2hFLDRFQUE4RDtBQUM5RCw2R0FBK0Y7QUFVL0YsSUFBQSxrQkFBUSxFQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtJQUNuRCxNQUFNLFlBQVksR0FBRyxZQUFZLENBQUM7SUFFbEMsb0RBQW9EO0lBQ3BELE1BQU0sZUFBZSxHQUFHO1FBQ3RCLEVBQUUsRUFBRSxXQUFXO1FBQ2YsS0FBSyxFQUFFLG1CQUFtQjtRQUMxQixjQUFjLEVBQUUsaUJBQWlCO1FBQ2pD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Q0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcV2luZG93c1xcT25lRHJpdmUgLSBTZWF0dGxlIENvbGxlZ2VzXFxEZXNrdG9wXFxZV01FU1NBR0lOR1xcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXHNlcnZpY2VzXFxhdXRoLnNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCwgYmVmb3JlRWFjaCwgYWZ0ZXJFYWNoLCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5cbi8vIFNldCB1cCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYmVmb3JlIGltcG9ydGluZyBtb2R1bGVzIHRoYXQgY2hlY2sgdGhlbVxucHJvY2Vzcy5lbnYuSldUX0FDQ0VTU19TRUNSRVQgPSAndGVzdF9hY2Nlc3Nfc2VjcmV0X2tleV8zMl9jaGFyc19taW5pbXVtJztcbnByb2Nlc3MuZW52LkpXVF9SRUZSRVNIX1NFQ1JFVCA9ICd0ZXN0X3JlZnJlc2hfc2VjcmV0X2tleV8zMl9jaGFyc19taW5pbXVtJztcbnByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCA9ICdwb3N0Z3Jlc3FsOi8vdGVzdDp0ZXN0QGxvY2FsaG9zdC90ZXN0JztcblxuaW1wb3J0ICogYXMgYXV0aFNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvYXV0aC5zZXJ2aWNlLmpzJztcbmltcG9ydCAqIGFzIHBhc3N3b3JkVXRpbHMgZnJvbSAnLi4vLi4vdXRpbHMvcGFzc3dvcmQudXRpbHMuanMnO1xuaW1wb3J0ICogYXMgand0VXRpbHMgZnJvbSAnLi4vLi4vdXRpbHMvand0LnV0aWxzLmpzJztcbmltcG9ydCAqIGFzIHN0cmlwZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvc3RyaXBlLnNlcnZpY2UuanMnO1xuaW1wb3J0ICogYXMgY2FjaGVTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2NhY2hlLnNlcnZpY2UuanMnO1xuaW1wb3J0ICogYXMgdGVuYW50UHJpc21hTGliIGZyb20gJy4uLy4uL2xpYi90ZW5hbnQtcHJpc21hLmpzJztcbmltcG9ydCAqIGFzIGRhdGFiYXNlUHJvdmlzaW9uaW5nU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9kYXRhYmFzZS1wcm92aXNpb25pbmcuc2VydmljZS5qcyc7XG5cbi8vIE1vY2sgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJy4uLy4uL2xpYi90ZW5hbnQtcHJpc21hLmpzJyk7XG5qZXN0Lm1vY2soJy4uLy4uL3NlcnZpY2VzL2RhdGFiYXNlLXByb3Zpc2lvbmluZy5zZXJ2aWNlLmpzJyk7XG5qZXN0Lm1vY2soJy4uLy4uL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlLmpzJyk7XG5qZXN0Lm1vY2soJy4uLy4uL3NlcnZpY2VzL2NhY2hlLnNlcnZpY2UuanMnKTtcbmplc3QubW9jaygnLi4vLi4vdXRpbHMvcGFzc3dvcmQudXRpbHMuanMnKTtcbmplc3QubW9jaygnLi4vLi4vdXRpbHMvand0LnV0aWxzLmpzJyk7XG5cbmRlc2NyaWJlKCdBdXRoZW50aWNhdGlvbiBTZXJ2aWNlIC0gVW5pdCBUZXN0cycsICgpID0+IHtcbiAgY29uc3QgbW9ja1RlbmFudElkID0gJ2NodXJjaC00NTYnO1xuXG4gIC8vIFRlbmFudC1sZXZlbCBhZG1pbiAobm8gY2h1cmNoSWQgaW4gdGVuYW50IHNjaGVtYSlcbiAgY29uc3QgbW9ja1RlbmFudEFkbWluID0ge1xuICAgIGlkOiAnYWRtaW4tMTIzJyxcbiAgICBlbWFpbDogJ3Bhc3RvckBjaHVyY2guY29tJyxcbiAgICBlbmNyeXB0ZWRFbWFpbDogJ2VuY3J5cHRlZF9lbWFpbCcsXG4gICAgZW1haWxIYXNoOiAnZW1haWxfaGFzaCcsXG4gICAgcGFzc3dvcmRIYXNoOiAnJDJiJDEwJGhhc2hlZFBhc3N3b3JkMTIzJyxcbiAgICBmaXJzdE5hbWU6ICdKb2huJyxcbiAgICBsYXN0TmFtZTogJ0RvZScsXG4gICAgcm9sZTogJ1BSSU1BUlknLFxuICAgIHdlbGNvbWVDb21wbGV0ZWQ6IGZhbHNlLFxuICAgIHVzZXJSb2xlOiAnYWRtaW4nLFxuICAgIGxhc3RMb2dpbkF0OiBuZXcgRGF0ZSgnMjAyNC0wMS0wMScpLFxuICB9O1xuXG4gIC8vIFJlZ2lzdHJ5LWxldmVsIGNodXJjaFxuICBjb25zdCBtb2NrQ2h1cmNoID0ge1xuICAgIGlkOiBtb2NrVGVuYW50SWQsXG4gICAgbmFtZTogJ0dyYWNlIENodXJjaCcsXG4gICAgZW1haWw6ICdwYXN0b3JAY2h1cmNoLmNvbScsXG4gICAgc3RyaXBlQ3VzdG9tZXJJZDogJ2N1c18xMjMnLFxuICAgIHRyaWFsRW5kc0F0OiBuZXcgRGF0ZSgnMjAyNC0wMi0wMScpLFxuICAgIHN1YnNjcmlwdGlvblN0YXR1czogJ3RyaWFsJyxcbiAgfTtcblxuICAvLyBNb2NrIFByaXNtYSBjbGllbnRzXG4gIGNvbnN0IG1vY2tSZWdpc3RyeVByaXNtYSA9IHtcbiAgICBjaHVyY2g6IHtcbiAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpIGFzIGplc3QuTW9jazxhbnk+LFxuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkgYXMgamVzdC5Nb2NrPGFueT4sXG4gICAgICB1cGRhdGU6IGplc3QuZm4oKSBhcyBqZXN0Lk1vY2s8YW55PixcbiAgICB9LFxuICAgIHRlbmFudDoge1xuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkgYXMgamVzdC5Nb2NrPGFueT4sXG4gICAgfSxcbiAgICBhZG1pbkVtYWlsSW5kZXg6IHtcbiAgICAgIGNyZWF0ZTogamVzdC5mbigpIGFzIGplc3QuTW9jazxhbnk+LFxuICAgIH0sXG4gIH07XG5cbiAgY29uc3QgbW9ja1RlbmFudFByaXNtYSA9IHtcbiAgICBhZG1pbjoge1xuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkgYXMgamVzdC5Nb2NrPGFueT4sXG4gICAgICBmaW5kRmlyc3Q6IGplc3QuZm4oKSBhcyBqZXN0Lk1vY2s8YW55PixcbiAgICAgIGZpbmRVbmlxdWU6IGplc3QuZm4oKSBhcyBqZXN0Lk1vY2s8YW55PixcbiAgICAgIHVwZGF0ZTogamVzdC5mbigpIGFzIGplc3QuTW9jazxhbnk+LFxuICAgIH0sXG4gIH07XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgKHRlbmFudFByaXNtYUxpYi5nZXRSZWdpc3RyeVByaXNtYSBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1JldHVyblZhbHVlKG1vY2tSZWdpc3RyeVByaXNtYSk7XG4gICAgKHRlbmFudFByaXNtYUxpYi5nZXRUZW5hbnRQcmlzbWEgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tUZW5hbnRQcmlzbWEpO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVnaXN0ZXJDaHVyY2gnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZWdpc3RlciBhIG5ldyBjaHVyY2ggc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVnaXN0ZXJJbnB1dCA9IHtcbiAgICAgICAgZW1haWw6ICduZXdwYXN0b3JAY2h1cmNoLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgICBmaXJzdE5hbWU6ICdKYW5lJyxcbiAgICAgICAgbGFzdE5hbWU6ICdTbWl0aCcsXG4gICAgICAgIGNodXJjaE5hbWU6ICdOZXcgR3JhY2UgQ2h1cmNoJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgcGFzc3dvcmQgaGFzaGluZ1xuICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSAnJDJiJDEwJG5ld0hhc2hlZFBhc3N3b3JkJztcbiAgICAgIChwYXNzd29yZFV0aWxzLmhhc2hQYXNzd29yZCBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUoaGFzaGVkUGFzc3dvcmQpO1xuXG4gICAgICAvLyBNb2NrIFN0cmlwZSBjdXN0b21lciBjcmVhdGlvblxuICAgICAgY29uc3Qgc3RyaXBlQ3VzdG9tZXJJZCA9ICdjdXNfc3RyaXBlX25ldyc7XG4gICAgICAoc3RyaXBlU2VydmljZS5jcmVhdGVDdXN0b21lciBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUoc3RyaXBlQ3VzdG9tZXJJZCk7XG5cbiAgICAgIC8vIE1vY2sgZGF0YWJhc2UgcHJvdmlzaW9uaW5nXG4gICAgICBjb25zdCB0ZW5hbnREYXRhYmFzZVVybCA9ICdwb3N0Z3Jlc3FsOi8vdXNlcjpwYXNzQGhvc3QvdGVuYW50X2RiX25ldyc7XG4gICAgICAoZGF0YWJhc2VQcm92aXNpb25pbmdTZXJ2aWNlLnByb3Zpc2lvblRlbmFudERhdGFiYXNlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZSh0ZW5hbnREYXRhYmFzZVVybCk7XG4gICAgICAoZGF0YWJhc2VQcm92aXNpb25pbmdTZXJ2aWNlLnJ1blRlbmFudE1pZ3JhdGlvbnMgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIC8vIE1vY2sgcmVnaXN0cnkgUHJpc21hIGNhbGxzXG4gICAgICAobW9ja1JlZ2lzdHJ5UHJpc21hLmNodXJjaC5maW5kRmlyc3QgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuICAgICAgKG1vY2tSZWdpc3RyeVByaXNtYS5jaHVyY2guY3JlYXRlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ2h1cmNoKTtcbiAgICAgIChtb2NrUmVnaXN0cnlQcmlzbWEudGVuYW50LmNyZWF0ZSBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogbW9ja1RlbmFudElkIH0pO1xuICAgICAgKG1vY2tSZWdpc3RyeVByaXNtYS5hZG1pbkVtYWlsSW5kZXguY3JlYXRlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSk7XG5cbiAgICAgIC8vIE1vY2sgdGVuYW50IFByaXNtYSBjYWxsc1xuICAgICAgKG1vY2tUZW5hbnRQcmlzbWEuYWRtaW4uY3JlYXRlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIC4uLm1vY2tUZW5hbnRBZG1pbixcbiAgICAgICAgZW1haWw6IHJlZ2lzdGVySW5wdXQuZW1haWwsXG4gICAgICAgIGZpcnN0TmFtZTogcmVnaXN0ZXJJbnB1dC5maXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lOiByZWdpc3RlcklucHV0Lmxhc3ROYW1lLFxuICAgICAgfSk7XG4gICAgICAobW9ja1RlbmFudFByaXNtYS5hZG1pbi51cGRhdGUgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tUZW5hbnRBZG1pbik7XG5cbiAgICAgIC8vIE1vY2sgdG9rZW4gZ2VuZXJhdGlvblxuICAgICAgKGp3dFV0aWxzLmdlbmVyYXRlQWNjZXNzVG9rZW4gYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXR1cm5WYWx1ZSgnYWNjZXNzX3Rva2VuXzEyMycpO1xuICAgICAgKGp3dFV0aWxzLmdlbmVyYXRlUmVmcmVzaFRva2VuIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmV0dXJuVmFsdWUoJ3JlZnJlc2hfdG9rZW5fMTIzJyk7XG5cbiAgICAgIC8vIEV4ZWN1dGVcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhTZXJ2aWNlLnJlZ2lzdGVyQ2h1cmNoKHJlZ2lzdGVySW5wdXQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LnRlbmFudElkKS50b0JlKG1vY2tUZW5hbnRJZCk7XG4gICAgICBleHBlY3QocmVzdWx0LmFkbWluLmVtYWlsKS50b0JlKHJlZ2lzdGVySW5wdXQuZW1haWwpO1xuICAgICAgZXhwZWN0KHBhc3N3b3JkVXRpbHMuaGFzaFBhc3N3b3JkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChyZWdpc3RlcklucHV0LnBhc3N3b3JkKTtcbiAgICAgIGV4cGVjdChzdHJpcGVTZXJ2aWNlLmNyZWF0ZUN1c3RvbWVyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByZXZlbnQgcmVnaXN0cmF0aW9uIHdpdGggZXhpc3RpbmcgZW1haWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZWdpc3RlcklucHV0ID0ge1xuICAgICAgICBlbWFpbDogJ2V4aXN0aW5nQGNodXJjaC5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ1NlY3VyZVBhc3MxMjMhJyxcbiAgICAgICAgZmlyc3ROYW1lOiAnSm9obicsXG4gICAgICAgIGxhc3ROYW1lOiAnRG9lJyxcbiAgICAgICAgY2h1cmNoTmFtZTogJ0V4aXN0aW5nIENodXJjaCcsXG4gICAgICB9O1xuXG4gICAgICAvLyBNb2NrIGV4aXN0aW5nIGNodXJjaFxuICAgICAgbW9ja1JlZ2lzdHJ5UHJpc21hLmNodXJjaC5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NodXJjaCk7XG5cbiAgICAgIC8vIEV4ZWN1dGUgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChhdXRoU2VydmljZS5yZWdpc3RlckNodXJjaChyZWdpc3RlcklucHV0KSkucmVqZWN0cy50b1Rocm93KCk7XG4gICAgICBleHBlY3QobW9ja1JlZ2lzdHJ5UHJpc21hLmNodXJjaC5maW5kRmlyc3QpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ2luJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbG9naW4gc3VjY2Vzc2Z1bGx5IHdpdGggY29ycmVjdCBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ2luSW5wdXQgPSB7XG4gICAgICAgIGVtYWlsOiBtb2NrVGVuYW50QWRtaW4uZW1haWwsXG4gICAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgfTtcblxuICAgICAgLy8gTW9jayByZWdpc3RyeSBjaHVyY2ggbG9va3VwXG4gICAgICAobW9ja1JlZ2lzdHJ5UHJpc21hLmNodXJjaC5maW5kRmlyc3QgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDaHVyY2gpO1xuXG4gICAgICAvLyBNb2NrIHRlbmFudCBhZG1pbiBsb29rdXBcbiAgICAgIChtb2NrVGVuYW50UHJpc21hLmFkbWluLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUobW9ja1RlbmFudEFkbWluKTtcblxuICAgICAgLy8gTW9jayBwYXNzd29yZCB2ZXJpZmljYXRpb25cbiAgICAgIChwYXNzd29yZFV0aWxzLmNvbXBhcmVQYXNzd29yZCBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSk7XG5cbiAgICAgIC8vIE1vY2sgdG9rZW4gZ2VuZXJhdGlvblxuICAgICAgKGp3dFV0aWxzLmdlbmVyYXRlQWNjZXNzVG9rZW4gYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXR1cm5WYWx1ZSgnYWNjZXNzX3Rva2VuXzEyMycpO1xuICAgICAgKGp3dFV0aWxzLmdlbmVyYXRlUmVmcmVzaFRva2VuIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmV0dXJuVmFsdWUoJ3JlZnJlc2hfdG9rZW5fMTIzJyk7XG5cbiAgICAgIC8vIE1vY2sgY2FjaGUgaW52YWxpZGF0aW9uXG4gICAgICAoY2FjaGVTZXJ2aWNlLmludmFsaWRhdGVDYWNoZSBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgLy8gTW9jayBsYXN0TG9naW5BdCB1cGRhdGVcbiAgICAgIChtb2NrVGVuYW50UHJpc21hLmFkbWluLnVwZGF0ZSBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUobW9ja1RlbmFudEFkbWluKTtcblxuICAgICAgLy8gRXhlY3V0ZVxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aFNlcnZpY2UubG9naW4obG9naW5JbnB1dCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuYWRtaW5JZCkudG9CZShtb2NrVGVuYW50QWRtaW4uaWQpO1xuICAgICAgZXhwZWN0KHJlc3VsdC50ZW5hbnRJZCkudG9CZShtb2NrVGVuYW50SWQpO1xuICAgICAgZXhwZWN0KHBhc3N3b3JkVXRpbHMuY29tcGFyZVBhc3N3b3JkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgbG9naW5JbnB1dC5wYXNzd29yZCxcbiAgICAgICAgbW9ja1RlbmFudEFkbWluLnBhc3N3b3JkSGFzaFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrVGVuYW50UHJpc21hLmFkbWluLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgbG9naW4gd2l0aCBpbmNvcnJlY3QgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dpbklucHV0ID0ge1xuICAgICAgICBlbWFpbDogbW9ja1RlbmFudEFkbWluLmVtYWlsLFxuICAgICAgICBwYXNzd29yZDogJ1dyb25nUGFzc3dvcmQxMjMhJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgcmVnaXN0cnkgY2h1cmNoIGxvb2t1cFxuICAgICAgKG1vY2tSZWdpc3RyeVByaXNtYS5jaHVyY2guZmluZEZpcnN0IGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ2h1cmNoKTtcblxuICAgICAgLy8gTW9jayB0ZW5hbnQgYWRtaW4gbG9va3VwXG4gICAgICAobW9ja1RlbmFudFByaXNtYS5hZG1pbi5maW5kRmlyc3QgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tUZW5hbnRBZG1pbik7XG5cbiAgICAgIC8vIE1vY2sgcGFzc3dvcmQgdmVyaWZpY2F0aW9uIChmYWlsKVxuICAgICAgKHBhc3N3b3JkVXRpbHMuY29tcGFyZVBhc3N3b3JkIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZShmYWxzZSk7XG5cbiAgICAgIC8vIEV4ZWN1dGUgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChhdXRoU2VydmljZS5sb2dpbihsb2dpbklucHV0KSkucmVqZWN0cy50b1Rocm93KCdJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBsb2dpbiB3aXRoIG5vbi1leGlzdGVudCBlbWFpbCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ2luSW5wdXQgPSB7XG4gICAgICAgIGVtYWlsOiAnbm9uZXhpc3RlbnRAY2h1cmNoLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgfTtcblxuICAgICAgLy8gTW9jayBjaHVyY2ggbm90IGZvdW5kXG4gICAgICAobW9ja1JlZ2lzdHJ5UHJpc21hLmNodXJjaC5maW5kRmlyc3QgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBFeGVjdXRlICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoYXV0aFNlcnZpY2UubG9naW4obG9naW5JbnB1dCkpLnJlamVjdHMudG9UaHJvdygnSW52YWxpZCBlbWFpbCBvciBwYXNzd29yZCcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVmcmVzaEFjY2Vzc1Rva2VuJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVmcmVzaCB0b2tlbnMgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWRtaW5JZCA9IG1vY2tUZW5hbnRBZG1pbi5pZDtcblxuICAgICAgLy8gTW9jayB0ZW5hbnQgYWRtaW4gbG9va3VwXG4gICAgICAobW9ja1RlbmFudFByaXNtYS5hZG1pbi5maW5kVW5pcXVlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVGVuYW50QWRtaW4pO1xuXG4gICAgICAvLyBNb2NrIHRva2VuIGdlbmVyYXRpb25cbiAgICAgIChqd3RVdGlscy5nZW5lcmF0ZUFjY2Vzc1Rva2VuIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmV0dXJuVmFsdWUoJ25ld19hY2Nlc3NfdG9rZW4nKTtcbiAgICAgIChqd3RVdGlscy5nZW5lcmF0ZVJlZnJlc2hUb2tlbiBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1JldHVyblZhbHVlKCduZXdfcmVmcmVzaF90b2tlbicpO1xuXG4gICAgICAvLyBFeGVjdXRlXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5yZWZyZXNoQWNjZXNzVG9rZW4oYWRtaW5JZCwgbW9ja1RlbmFudElkKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5hY2Nlc3NUb2tlbikudG9CZSgnbmV3X2FjY2Vzc190b2tlbicpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5yZWZyZXNoVG9rZW4pLnRvQmUoJ25ld19yZWZyZXNoX3Rva2VuJyk7XG4gICAgICBleHBlY3Qoand0VXRpbHMuZ2VuZXJhdGVBY2Nlc3NUb2tlbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGFkbWluSWQsXG4gICAgICAgIG1vY2tUZW5hbnRJZCxcbiAgICAgICAgbW9ja1RlbmFudEFkbWluLnJvbGVcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIGFkbWluIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFkbWluSWQgPSAnbm9uZXhpc3RlbnQtYWRtaW4nO1xuXG4gICAgICAvLyBNb2NrIHRlbmFudCBhZG1pbiBub3QgZm91bmRcbiAgICAgIChtb2NrVGVuYW50UHJpc21hLmFkbWluLmZpbmRVbmlxdWUgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBFeGVjdXRlICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoYXV0aFNlcnZpY2UucmVmcmVzaEFjY2Vzc1Rva2VuKGFkbWluSWQsIG1vY2tUZW5hbnRJZCkpLnJlamVjdHMudG9UaHJvdygnQWRtaW4gbm90IGZvdW5kJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRBZG1pbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHJpZXZlIGFkbWluIGZyb20gY2FjaGUgaWYgYXZhaWxhYmxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWRtaW5JZCA9IG1vY2tUZW5hbnRBZG1pbi5pZDtcbiAgICAgIGNvbnN0IGNhY2hlZEFkbWluID0ge1xuICAgICAgICAuLi5tb2NrVGVuYW50QWRtaW4sXG4gICAgICAgIHRlbmFudElkOiBtb2NrVGVuYW50SWQsXG4gICAgICB9O1xuXG4gICAgICAvLyBNb2NrIGNhY2hlIGhpdFxuICAgICAgKGNhY2hlU2VydmljZS5nZXRDYWNoZWQgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKGNhY2hlZEFkbWluKTtcblxuICAgICAgLy8gRXhlY3V0ZVxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aFNlcnZpY2UuZ2V0QWRtaW4oYWRtaW5JZCwgbW9ja1RlbmFudElkKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGNhY2hlZEFkbWluKTtcbiAgICAgIGV4cGVjdChtb2NrVGVuYW50UHJpc21hLmFkbWluLmZpbmRVbmlxdWUpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZldGNoIGFkbWluIGZyb20gZGF0YWJhc2UgaWYgbm90IGNhY2hlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFkbWluSWQgPSBtb2NrVGVuYW50QWRtaW4uaWQ7XG5cbiAgICAgIC8vIE1vY2sgY2FjaGUgbWlzc1xuICAgICAgKGNhY2hlU2VydmljZS5nZXRDYWNoZWQgYXMgamVzdC5Nb2NrPGFueT4pLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBNb2NrIHRlbmFudCBQcmlzbWEgY2FsbFxuICAgICAgKG1vY2tUZW5hbnRQcmlzbWEuYWRtaW4uZmluZFVuaXF1ZSBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUobW9ja1RlbmFudEFkbWluKTtcblxuICAgICAgLy8gTW9jayBjYWNoZSBzZXRcbiAgICAgIChjYWNoZVNlcnZpY2Uuc2V0Q2FjaGVkIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICAvLyBFeGVjdXRlXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5nZXRBZG1pbihhZG1pbklkLCBtb2NrVGVuYW50SWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LmlkKS50b0JlKGFkbWluSWQpO1xuICAgICAgZXhwZWN0KG1vY2tUZW5hbnRQcmlzbWEuYWRtaW4uZmluZFVuaXF1ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB3aGVyZTogeyBpZDogYWRtaW5JZCB9LFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoY2FjaGVTZXJ2aWNlLnNldENhY2hlZCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBpZiBhZG1pbiBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhZG1pbklkID0gJ25vbmV4aXN0ZW50LWFkbWluJztcblxuICAgICAgLy8gTW9jayBjYWNoZSBtaXNzXG4gICAgICAoY2FjaGVTZXJ2aWNlLmdldENhY2hlZCBhcyBqZXN0Lk1vY2s8YW55PikubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIC8vIE1vY2sgdGVuYW50IFByaXNtYSBjYWxsIChub3QgZm91bmQpXG4gICAgICAobW9ja1RlbmFudFByaXNtYS5hZG1pbi5maW5kVW5pcXVlIGFzIGplc3QuTW9jazxhbnk+KS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgLy8gRXhlY3V0ZVxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aFNlcnZpY2UuZ2V0QWRtaW4oYWRtaW5JZCwgbW9ja1RlbmFudElkKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9