{"file":"C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\__tests__\\services\\auth.service.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\__tests__\\services\\auth.service.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach, jest } from '@jest/globals';\nimport * as authService from '../../services/auth.service.js';\nimport * as passwordUtils from '../../utils/password.utils.js';\nimport * as jwtUtils from '../../utils/jwt.utils.js';\nimport * as stripeService from '../../services/stripe.service.js';\nimport * as cacheService from '../../services/cache.service.js';\nimport * as tenantPrismaLib from '../../lib/tenant-prisma.js';\nimport * as databaseProvisioningService from '../../services/database-provisioning.service.js';\n\n// Mock dependencies\njest.mock('../../lib/tenant-prisma.js');\njest.mock('../../services/database-provisioning.service.js');\njest.mock('../../services/stripe.service.js');\njest.mock('../../services/cache.service.js');\njest.mock('../../utils/password.utils.js');\njest.mock('../../utils/jwt.utils.js');\n\ndescribe('Authentication Service - Unit Tests', () => {\n  const mockTenantId = 'church-456';\n\n  // Tenant-level admin (no churchId in tenant schema)\n  const mockTenantAdmin = {\n    id: 'admin-123',\n    email: 'pastor@church.com',\n    encryptedEmail: 'encrypted_email',\n    emailHash: 'email_hash',\n    passwordHash: '$2b$10$hashedPassword123',\n    firstName: 'John',\n    lastName: 'Doe',\n    role: 'PRIMARY',\n    welcomeCompleted: false,\n    userRole: 'admin',\n    lastLoginAt: new Date('2024-01-01'),\n  };\n\n  // Registry-level church\n  const mockChurch = {\n    id: mockTenantId,\n    name: 'Grace Church',\n    email: 'pastor@church.com',\n    stripeCustomerId: 'cus_123',\n    trialEndsAt: new Date('2024-02-01'),\n    subscriptionStatus: 'trial',\n  };\n\n  // Mock Prisma clients\n  const mockRegistryPrisma = {\n    church: {\n      findFirst: jest.fn() as jest.Mock<any>,\n      create: jest.fn() as jest.Mock<any>,\n      update: jest.fn() as jest.Mock<any>,\n    },\n    tenant: {\n      create: jest.fn() as jest.Mock<any>,\n    },\n    adminEmailIndex: {\n      create: jest.fn() as jest.Mock<any>,\n    },\n  };\n\n  const mockTenantPrisma = {\n    admin: {\n      create: jest.fn() as jest.Mock<any>,\n      findFirst: jest.fn() as jest.Mock<any>,\n      findUnique: jest.fn() as jest.Mock<any>,\n      update: jest.fn() as jest.Mock<any>,\n    },\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (tenantPrismaLib.getRegistryPrisma as jest.Mock<any>).mockReturnValue(mockRegistryPrisma);\n    (tenantPrismaLib.getTenantPrisma as jest.Mock<any>).mockResolvedValue(mockTenantPrisma);\n  });\n\n  describe('registerChurch', () => {\n    it('should register a new church successfully', async () => {\n      const registerInput = {\n        email: 'newpastor@church.com',\n        password: 'SecurePass123!',\n        firstName: 'Jane',\n        lastName: 'Smith',\n        churchName: 'New Grace Church',\n      };\n\n      // Mock password hashing\n      const hashedPassword = '$2b$10$newHashedPassword';\n      (passwordUtils.hashPassword as jest.Mock<any>).mockResolvedValue(hashedPassword);\n\n      // Mock Stripe customer creation\n      const stripeCustomerId = 'cus_stripe_new';\n      (stripeService.createCustomer as jest.Mock<any>).mockResolvedValue(stripeCustomerId);\n\n      // Mock database provisioning\n      const tenantDatabaseUrl = 'postgresql://user:pass@host/tenant_db_new';\n      (databaseProvisioningService.provisionTenantDatabase as jest.Mock<any>).mockResolvedValue(tenantDatabaseUrl);\n      (databaseProvisioningService.runTenantMigrations as jest.Mock<any>).mockResolvedValue(undefined);\n\n      // Mock registry Prisma calls\n      (mockRegistryPrisma.church.findFirst as jest.Mock<any>).mockResolvedValue(null);\n      (mockRegistryPrisma.church.create as jest.Mock<any>).mockResolvedValue(mockChurch);\n      (mockRegistryPrisma.tenant.create as jest.Mock<any>).mockResolvedValue({ id: mockTenantId });\n      (mockRegistryPrisma.adminEmailIndex.create as jest.Mock<any>).mockResolvedValue({});\n\n      // Mock tenant Prisma calls\n      (mockTenantPrisma.admin.create as jest.Mock<any>).mockResolvedValue({\n        ...mockTenantAdmin,\n        email: registerInput.email,\n        firstName: registerInput.firstName,\n        lastName: registerInput.lastName,\n      });\n      (mockTenantPrisma.admin.update as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Mock token generation\n      (jwtUtils.generateAccessToken as jest.Mock<any>).mockReturnValue('access_token_123');\n      (jwtUtils.generateRefreshToken as jest.Mock<any>).mockReturnValue('refresh_token_123');\n\n      // Execute\n      const result = await authService.registerChurch(registerInput);\n\n      // Assert\n      expect(result).toBeDefined();\n      expect(result.tenantId).toBe(mockTenantId);\n      expect(result.admin.email).toBe(registerInput.email);\n      expect(passwordUtils.hashPassword).toHaveBeenCalledWith(registerInput.password);\n      expect(stripeService.createCustomer).toHaveBeenCalled();\n    });\n\n    it('should prevent registration with existing email', async () => {\n      const registerInput = {\n        email: 'existing@church.com',\n        password: 'SecurePass123!',\n        firstName: 'John',\n        lastName: 'Doe',\n        churchName: 'Existing Church',\n      };\n\n      // Mock existing church\n      mockRegistryPrisma.church.findFirst.mockResolvedValue(mockChurch);\n\n      // Execute & Assert\n      await expect(authService.registerChurch(registerInput)).rejects.toThrow();\n      expect(mockRegistryPrisma.church.findFirst).toHaveBeenCalled();\n    });\n  });\n\n  describe('login', () => {\n    it('should login successfully with correct credentials', async () => {\n      const loginInput = {\n        email: mockTenantAdmin.email,\n        password: 'SecurePass123!',\n      };\n\n      // Mock registry church lookup\n      (mockRegistryPrisma.church.findFirst as jest.Mock<any>).mockResolvedValue(mockChurch);\n\n      // Mock tenant admin lookup\n      (mockTenantPrisma.admin.findFirst as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Mock password verification\n      (passwordUtils.comparePassword as jest.Mock<any>).mockResolvedValue(true);\n\n      // Mock token generation\n      (jwtUtils.generateAccessToken as jest.Mock<any>).mockReturnValue('access_token_123');\n      (jwtUtils.generateRefreshToken as jest.Mock<any>).mockReturnValue('refresh_token_123');\n\n      // Mock cache invalidation\n      (cacheService.invalidateCache as jest.Mock<any>).mockResolvedValue(undefined);\n\n      // Mock lastLoginAt update\n      (mockTenantPrisma.admin.update as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Execute\n      const result = await authService.login(loginInput);\n\n      // Assert\n      expect(result).toBeDefined();\n      expect(result.adminId).toBe(mockTenantAdmin.id);\n      expect(result.tenantId).toBe(mockTenantId);\n      expect(passwordUtils.comparePassword).toHaveBeenCalledWith(\n        loginInput.password,\n        mockTenantAdmin.passwordHash\n      );\n      expect(mockTenantPrisma.admin.update).toHaveBeenCalled();\n    });\n\n    it('should reject login with incorrect password', async () => {\n      const loginInput = {\n        email: mockTenantAdmin.email,\n        password: 'WrongPassword123!',\n      };\n\n      // Mock registry church lookup\n      (mockRegistryPrisma.church.findFirst as jest.Mock<any>).mockResolvedValue(mockChurch);\n\n      // Mock tenant admin lookup\n      (mockTenantPrisma.admin.findFirst as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Mock password verification (fail)\n      (passwordUtils.comparePassword as jest.Mock<any>).mockResolvedValue(false);\n\n      // Execute & Assert\n      await expect(authService.login(loginInput)).rejects.toThrow('Invalid email or password');\n    });\n\n    it('should reject login with non-existent email', async () => {\n      const loginInput = {\n        email: 'nonexistent@church.com',\n        password: 'SecurePass123!',\n      };\n\n      // Mock church not found\n      (mockRegistryPrisma.church.findFirst as jest.Mock<any>).mockResolvedValue(null);\n\n      // Execute & Assert\n      await expect(authService.login(loginInput)).rejects.toThrow('Invalid email or password');\n    });\n  });\n\n  describe('refreshAccessToken', () => {\n    it('should refresh tokens successfully', async () => {\n      const adminId = mockTenantAdmin.id;\n\n      // Mock tenant admin lookup\n      (mockTenantPrisma.admin.findUnique as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Mock token generation\n      (jwtUtils.generateAccessToken as jest.Mock<any>).mockReturnValue('new_access_token');\n      (jwtUtils.generateRefreshToken as jest.Mock<any>).mockReturnValue('new_refresh_token');\n\n      // Execute\n      const result = await authService.refreshAccessToken(adminId, mockTenantId);\n\n      // Assert\n      expect(result).toBeDefined();\n      expect(result.accessToken).toBe('new_access_token');\n      expect(result.refreshToken).toBe('new_refresh_token');\n      expect(jwtUtils.generateAccessToken).toHaveBeenCalledWith(\n        adminId,\n        mockTenantId,\n        mockTenantAdmin.role\n      );\n    });\n\n    it('should throw error if admin not found', async () => {\n      const adminId = 'nonexistent-admin';\n\n      // Mock tenant admin not found\n      (mockTenantPrisma.admin.findUnique as jest.Mock<any>).mockResolvedValue(null);\n\n      // Execute & Assert\n      await expect(authService.refreshAccessToken(adminId, mockTenantId)).rejects.toThrow('Admin not found');\n    });\n  });\n\n  describe('getAdmin', () => {\n    it('should retrieve admin from cache if available', async () => {\n      const adminId = mockTenantAdmin.id;\n      const cachedAdmin = {\n        ...mockTenantAdmin,\n        tenantId: mockTenantId,\n      };\n\n      // Mock cache hit\n      (cacheService.getCached as jest.Mock<any>).mockResolvedValue(cachedAdmin);\n\n      // Execute\n      const result = await authService.getAdmin(adminId, mockTenantId);\n\n      // Assert\n      expect(result).toEqual(cachedAdmin);\n      expect(mockTenantPrisma.admin.findUnique).not.toHaveBeenCalled();\n    });\n\n    it('should fetch admin from database if not cached', async () => {\n      const adminId = mockTenantAdmin.id;\n\n      // Mock cache miss\n      (cacheService.getCached as jest.Mock<any>).mockResolvedValue(null);\n\n      // Mock tenant Prisma call\n      (mockTenantPrisma.admin.findUnique as jest.Mock<any>).mockResolvedValue(mockTenantAdmin);\n\n      // Mock cache set\n      (cacheService.setCached as jest.Mock<any>).mockResolvedValue(undefined);\n\n      // Execute\n      const result = await authService.getAdmin(adminId, mockTenantId);\n\n      // Assert\n      expect(result).toBeDefined();\n      expect(result.id).toBe(adminId);\n      expect(mockTenantPrisma.admin.findUnique).toHaveBeenCalledWith({\n        where: { id: adminId },\n      });\n      expect(cacheService.setCached).toHaveBeenCalled();\n    });\n\n    it('should return null if admin not found', async () => {\n      const adminId = 'nonexistent-admin';\n\n      // Mock cache miss\n      (cacheService.getCached as jest.Mock<any>).mockResolvedValue(null);\n\n      // Mock tenant Prisma call (not found)\n      (mockTenantPrisma.admin.findUnique as jest.Mock<any>).mockResolvedValue(null);\n\n      // Execute\n      const result = await authService.getAdmin(adminId, mockTenantId);\n\n      // Assert\n      expect(result).toBeNull();\n    });\n  });\n});\n"],"version":3}