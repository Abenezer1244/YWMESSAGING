{"file":"C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\auth.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Windows\\OneDrive - Seattle Colleges\\Desktop\\YWMESSAGING\\backend\\src\\services\\auth.service.ts"],"sourcesContent":["/**\n * Authentication Service (Multi-Tenant)\n *\n * Handles:\n * - Church registration (creates Tenant in registry, provisions database, creates Admin)\n * - Admin login (finds tenant via registry, accesses tenant database)\n * - Token management\n */\n\nimport { hashPassword, comparePassword } from '../utils/password.utils.js';\nimport { generateAccessToken, generateRefreshToken } from '../utils/jwt.utils.js';\nimport { createCustomer } from './stripe.service.js';\nimport { getCached, setCached, invalidateCache, CACHE_KEYS, CACHE_TTL } from './cache.service.js';\nimport { encrypt, hashForSearch } from '../utils/encryption.utils.js';\nimport { createId } from '@paralleldrive/cuid2';\nimport { getRegistryPrisma, getTenantPrisma } from '../lib/tenant-prisma.js';\nimport {\n  provisionTenantDatabase,\n  runTenantMigrations,\n  deleteTenantDatabase\n} from './database-provisioning.service.js';\nimport {\n  createCustomSpan,\n  createDatabaseSpan,\n  createExternalApiSpan\n} from '../utils/apm-instrumentation.js';\n\nconst TRIAL_DAYS = parseInt(process.env.TRIAL_DAYS || '14');\n\nexport interface RegisterInput {\n  email: string;\n  password: string;\n  firstName: string;\n  lastName: string;\n  churchName: string;\n}\n\nexport interface RegisterResponse {\n  tenantId: string;\n  adminId: string;\n  accessToken: string;\n  refreshToken: string;\n  admin: any;\n  church: any;\n}\n\nexport interface LoginInput {\n  email: string;\n  password: string;\n}\n\nexport interface LoginResponse {\n  tenantId: string;\n  adminId: string;\n  accessToken: string;\n  refreshToken: string;\n  admin: any;\n  church: any;\n}\n\n/**\n * Register a new church and admin\n * PHASE 4: Database-per-tenant provisioning\n *\n * Flow:\n * 1. Generate tenantId\n * 2. Validate email not in use\n * 3. Provision new PostgreSQL database for tenant\n * 4. Run tenant schema migrations\n * 5. Create Church in registry\n * 6. Create Tenant record in registry (links to new database)\n * 7. Create Admin in registry\n * 8. Create AdminEmailIndex for fast email lookup\n * 9. Create Admin in tenant database\n * 10. Generate tokens\n */\nexport async function registerChurch(input: RegisterInput): Promise<RegisterResponse> {\n  const tenantId = createId();\n  const registryPrisma = getRegistryPrisma();\n  let tenantDatabaseUrl: string | null = null;\n\n  try {\n    console.log(`[Register] Starting registration for church: ${input.churchName}`);\n\n    // ============================================\n    // STEP 1: Validate email not already used\n    // ============================================\n    console.log('[Register] Validating email availability...');\n    const existingChurch = await registryPrisma.church.findFirst({\n      where: { email: input.email },\n    });\n\n    if (existingChurch) {\n      console.warn(`[Register] Email already in use: ${input.email}`);\n      throw new Error('Email already registered. Please use a different email or contact support.');\n    }\n\n    // ============================================\n    // STEP 2: Provision tenant database\n    // ============================================\n    console.log(`[Register] Provisioning database for tenant ${tenantId}...`);\n    try {\n      tenantDatabaseUrl = await provisionTenantDatabase(tenantId);\n      console.log(`[Register] Database provisioned: ${tenantDatabaseUrl.split('@')[1]}`); // Log without password\n    } catch (error: any) {\n      throw new Error(`Database provisioning failed: ${error.message}`);\n    }\n\n    // ============================================\n    // STEP 3: Run migrations on new database\n    // ============================================\n    console.log(`[Register] Running migrations for tenant ${tenantId}...`);\n    try {\n      await runTenantMigrations(tenantDatabaseUrl);\n      console.log(`[Register] Migrations completed for tenant ${tenantId}`);\n    } catch (error: any) {\n      // Rollback: Delete database on migration failure\n      console.error(`[Register] Migrations failed, rolling back database...`);\n      await deleteTenantDatabase(tenantId).catch((err) => {\n        console.error(`[Register] Failed to rollback database ${tenantId}: ${err.message}`);\n      });\n      throw error;\n    }\n\n    // ============================================\n    // STEP 4: Extract database connection details\n    // ============================================\n    const dbUrlObj = new URL(tenantDatabaseUrl);\n    const databaseHost = dbUrlObj.hostname;\n    const databasePort = parseInt(dbUrlObj.port || '5432');\n    const databaseName = dbUrlObj.pathname.slice(1);\n\n    // ============================================\n    // STEP 5: Create Stripe customer\n    // ============================================\n    console.log('[Register] Creating Stripe customer...');\n    const stripeCustomerId = await createExternalApiSpan(\n      'stripe',\n      'customer.create',\n      () => createCustomer(input.email, input.churchName),\n      { email: input.email, churchName: input.churchName }\n    );\n\n    // ============================================\n    // STEP 6: Calculate trial end date\n    // ============================================\n    const trialEndsAt = new Date();\n    trialEndsAt.setDate(trialEndsAt.getDate() + TRIAL_DAYS);\n\n    // ============================================\n    // STEP 7: Create Church record in registry\n    // ============================================\n    console.log(`[Register] Creating Church record for ${tenantId}...`);\n    const church = await registryPrisma.church.create({\n      data: {\n        id: tenantId,\n        name: input.churchName,\n        email: input.email,\n        stripeCustomerId,\n        subscriptionStatus: 'trial',\n        trialEndsAt,\n      },\n    });\n    console.log(`[Register] Church created: ${church.id}`);\n\n    // ============================================\n    // STEP 8: Create Tenant registry record\n    // ============================================\n    console.log(`[Register] Creating Tenant registry record for ${tenantId}...`);\n    const tenant = await registryPrisma.tenant.create({\n      data: {\n        id: tenantId,\n        churchId: tenantId,\n        name: input.churchName,\n        email: input.email,\n        databaseUrl: tenantDatabaseUrl,\n        databaseHost,\n        databasePort,\n        databaseName,\n        status: 'active',\n        subscriptionStatus: 'trial',\n        subscriptionPlan: 'starter',\n      },\n    });\n    console.log(`[Register] Tenant registry record created: ${tenant.id}`);\n\n    // ============================================\n    // STEP 9: Prepare password and email hashes\n    // ============================================\n    const passwordHash = await hashPassword(input.password);\n    const encryptedEmail = encrypt(input.email);\n    const emailHash = hashForSearch(input.email);\n\n    // ============================================\n    // STEP 10: Create Admin in tenant database\n    // ============================================\n    console.log(`[Register] Creating Admin in tenant database...`);\n    const tenantPrisma = await getTenantPrisma(tenantId);\n    const tenantAdmin = await tenantPrisma.admin.create({\n      data: {\n        email: input.email,\n        encryptedEmail,\n        emailHash,\n        passwordHash,\n        firstName: input.firstName,\n        lastName: input.lastName,\n        role: 'PRIMARY',\n      },\n    });\n    console.log(`[Register] Admin created in tenant database: ${tenantAdmin.id}`);\n\n    // ============================================\n    // STEP 11: Create AdminEmailIndex for fast lookup\n    // ============================================\n    console.log(`[Register] Creating AdminEmailIndex entry...`);\n    await registryPrisma.adminEmailIndex.create({\n      data: {\n        email: input.email,\n        emailHash,\n        tenantId,\n        adminId: tenantAdmin.id,\n      },\n    });\n    console.log(`[Register] AdminEmailIndex entry created`);\n\n    // ============================================\n    // STEP 12: Generate tokens\n    // ============================================\n    const accessToken = generateAccessToken(tenantAdmin.id, tenantId, tenantAdmin.role);\n    const refreshToken = generateRefreshToken(tenantAdmin.id, tenantId);\n\n    // ============================================\n    // STEP 13: Update last login\n    // ============================================\n    await tenantPrisma.admin.update({\n      where: { id: tenantAdmin.id },\n      data: { lastLoginAt: new Date() },\n    });\n\n    console.log(`âœ… Registration completed successfully: ${tenantId}`);\n\n    return {\n      tenantId,\n      adminId: tenantAdmin.id,\n      accessToken,\n      refreshToken,\n      admin: {\n        id: tenantAdmin.id,\n        email: tenantAdmin.email,\n        firstName: tenantAdmin.firstName,\n        lastName: tenantAdmin.lastName,\n        role: tenantAdmin.role,\n        welcomeCompleted: tenantAdmin.welcomeCompleted || false,\n        userRole: tenantAdmin.userRole || null,\n      },\n      church: {\n        id: tenantId,\n        name: church.name,\n        subscriptionStatus: church.subscriptionStatus,\n        trialEndsAt: church.trialEndsAt,\n      },\n    };\n  } catch (error: any) {\n    console.error(`[Register] Registration failed for ${tenantId}: ${error.message}`);\n\n    // Cleanup: Delete database if it was created but signup failed\n    if (tenantDatabaseUrl) {\n      console.log(`[Register] Cleaning up orphaned database for ${tenantId}...`);\n      await deleteTenantDatabase(tenantId).catch((err) => {\n        console.error(`[Register] Failed to clean up database ${tenantId}: ${err.message}`);\n      });\n    }\n\n    throw error;\n  }\n}\n\n/**\n * Login with email and password\n * 1. Find tenant via email hash in AdminEmailIndex (registry)\n * 2. Get admin from tenant database\n * 3. Verify password\n * 4. Generate tokens\n */\nexport async function login(input: LoginInput): Promise<LoginResponse> {\n  return new Promise<LoginResponse>((resolve, reject) => {\n    const timeoutId = setTimeout(() => {\n      console.error('[LOGIN] FUNCTION TIMEOUT - login exceeded 5 seconds');\n      reject(new Error('Login took too long. Please try again.'));\n    }, 5000);\n\n    loginInternal(input)\n      .then((result) => {\n        clearTimeout(timeoutId);\n        resolve(result);\n      })\n      .catch((error) => {\n        clearTimeout(timeoutId);\n        reject(error);\n      });\n  });\n}\n\nasync function loginInternal(input: LoginInput): Promise<LoginResponse> {\n  return createCustomSpan(\n    'admin.login',\n    async () => {\n      console.log('[LOGIN] Starting login process for:', input.email);\n\n      const registryPrisma = getRegistryPrisma();\n\n      // SECURITY: Find church by email first to identify the tenant\n      console.log('[LOGIN] Looking up church by email...');\n      const church = await createDatabaseSpan(\n        'SELECT',\n        'church',\n        () => registryPrisma.church.findFirst({\n          where: { email: input.email },\n        }),\n        { email: input.email }\n      );\n\n      if (!church) {\n        console.log('[LOGIN] Church not found with email:', input.email);\n        throw new Error('Invalid email or password');\n      }\n\n      const tenantId = church.id;\n\n      // Get tenant-scoped database client\n      const tenantPrisma = await getTenantPrisma(tenantId);\n\n      // SECURITY: Find admin by email in tenant database\n      console.log('[LOGIN] Looking up admin for church:', tenantId);\n      const admin = await createDatabaseSpan(\n        'SELECT',\n        'admin',\n        () => tenantPrisma.admin.findFirst({\n          where: {\n            email: input.email,\n          },\n        }),\n        { tenantId, email: input.email }\n      );\n\n      if (!admin) {\n        console.log('[LOGIN] Admin not found for church:', tenantId);\n        throw new Error('Invalid email or password');\n      }\n\n      console.log('[LOGIN] Admin found, comparing password...');\n      // Verify password\n      const passwordMatch = await comparePassword(input.password, admin.passwordHash);\n      if (!passwordMatch) {\n        console.log('[LOGIN] Password does not match');\n        throw new Error('Invalid email or password');\n      }\n\n      console.log('[LOGIN] Password matched, generating tokens...');\n      // Generate tokens\n      const accessToken = generateAccessToken(admin.id, tenantId, admin.role);\n      const refreshToken = generateRefreshToken(admin.id, tenantId);\n\n      console.log('[LOGIN] Updating lastLoginAt...');\n      // Update lastLoginAt in tenant database\n      await tenantPrisma.admin.update({\n        where: { id: admin.id },\n        data: { lastLoginAt: new Date() },\n      });\n\n      console.log('[LOGIN] Invalidating cache (non-blocking)...');\n      // Invalidate admin cache to refresh permissions (non-blocking)\n      invalidateCache(CACHE_KEYS.adminRole(admin.id)).catch((err) => {\n        console.error('[LOGIN] Cache invalidation failed:', err.message);\n      });\n\n      return {\n        tenantId,\n        adminId: admin.id,\n        accessToken,\n        refreshToken,\n        admin: {\n          id: admin.id,\n          email: admin.email,\n          firstName: admin.firstName,\n          lastName: admin.lastName,\n          role: admin.role,\n          welcomeCompleted: admin.welcomeCompleted || false,\n          userRole: admin.userRole || null,\n        },\n        church: {\n          id: church.id,\n          name: church.name,\n          subscriptionStatus: church.subscriptionStatus,\n          trialEndsAt: church.trialEndsAt,\n        },\n      };\n    },\n    { email: input.email }\n  );\n}\n\n/**\n * Refresh access token\n * Generates new tokens with existing tenantId\n */\nexport async function refreshAccessToken(\n  adminId: string,\n  tenantId: string\n): Promise<{\n  accessToken: string;\n  refreshToken: string;\n}> {\n  try {\n    const tenantPrisma = await getTenantPrisma(tenantId);\n    const admin = await tenantPrisma.admin.findUnique({\n      where: { id: adminId },\n    });\n\n    if (!admin) {\n      throw new Error('Admin not found');\n    }\n\n    const accessToken = generateAccessToken(admin.id, tenantId, admin.role);\n    const refreshToken = generateRefreshToken(admin.id, tenantId);\n\n    return {\n      accessToken,\n      refreshToken,\n    };\n  } catch (error: any) {\n    console.error('Error refreshing access token:', error);\n    throw error;\n  }\n}\n\n/**\n * Get admin by ID\n * Cached for 30 minutes\n */\nexport async function getAdmin(adminId: string, tenantId: string) {\n  try {\n    // Try cache first\n    const cached = await getCached<any>(CACHE_KEYS.adminRole(adminId));\n    if (cached) {\n      return cached;\n    }\n\n    const tenantPrisma = await getTenantPrisma(tenantId);\n    const admin = await tenantPrisma.admin.findUnique({\n      where: { id: adminId },\n    });\n\n    if (!admin) {\n      return null;\n    }\n\n    const result = {\n      id: admin.id,\n      email: admin.email,\n      firstName: admin.firstName,\n      lastName: admin.lastName,\n      role: admin.role,\n      welcomeCompleted: admin.welcomeCompleted || false,\n      userRole: admin.userRole || null,\n      tenantId,\n    };\n\n    // Cache for 30 minutes\n    await setCached(CACHE_KEYS.adminRole(adminId), result, CACHE_TTL.MEDIUM);\n\n    return result;\n  } catch (error: any) {\n    console.error('Error getting admin:', error);\n    throw error;\n  }\n}\n"],"version":3}