// ============================================================================
// KOINONIA REGISTRY SCHEMA
// ============================================================================
// Central registry database that stores tenant metadata and routing information
// This is a SEPARATE database from tenant databases
//
// Purpose:
// - Store which database each church (tenant) uses
// - Route incoming webhooks to correct tenant database
// - Manage phone number -> tenant mappings
// - Fast admin email lookups during login
//
// Each church gets its own PostgreSQL database (stored as encrypted URL in tenantDatabaseUrl)
// ============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/registry-client"
}

datasource db {
  provider = "postgresql"
  url      = env("REGISTRY_DATABASE_URL")

  // Connection pooling for registry database
  // Registry is accessed for every request (tenant lookup)
  // More conservative limits than tenant databases
}

// ============================================================================
// CORE TENANT METADATA
// ============================================================================
// Stores metadata for each church tenant
// The actual church data (admins, branches, members, etc) is in separate tenant databases
model Tenant {
  id                    String   @id // Same as churchId from original schema
  name                  String   // Church name
  email                 String   @unique // Church contact email

  // ====== DATABASE CONNECTION INFO ======
  // Encrypted PostgreSQL connection string to tenant's private database
  tenantDatabaseUrl     String   // Encrypted: postgresql://user:pass@host/church_id
  tenantDatabaseHost    String   // Host for monitoring
  tenantDatabasePort    Int      // Port for monitoring
  tenantDatabaseName    String   // Database name (e.g., church_cm12abc3def)

  // ====== TENANT STATUS ======
  status                String   @default("active") // active, suspended, archived, deleted

  // ====== PHONE NUMBER ======
  // Telnyx phone number for this church
  // Used for webhook routing (incoming SMS/MMS -> which tenant?)
  telnyxPhoneNumber     String?  @unique

  // ====== SUBSCRIPTION INFO ======
  // Denormalized from tenant database for quick access
  // Updated whenever subscription changes
  subscriptionStatus    String   @default("trial") // trial, active, paused, canceled
  subscriptionPlan      String   @default("starter") // starter, growth, pro
  trialEndsAt           DateTime
  subscriptionStartsAt  DateTime?

  // ====== STRIPE ======
  stripeCustomerId      String?  @unique

  // ====== DATABASE SCHEMA VERSION ======
  // Track which schema version this tenant database is running
  // Used for migrations and compatibility checks
  tenantSchemaVersion   String   @default("1.0.0")

  // ====== AUDIT TIMESTAMPS ======
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastAccessedAt        DateTime @default(now()) // Updated on every request for monitoring

  // ====== RELATIONS ======
  phoneNumbers          PhoneNumberRegistry[]
  adminEmailIndex       AdminEmailIndex[]

  @@index([status])
  @@index([telnyxPhoneNumber])
  @@index([subscriptionStatus])
  @@index([createdAt])
}

// ============================================================================
// PHONE NUMBER REGISTRY
// ============================================================================
// Maps phone numbers to tenants for webhook routing
// When Telnyx sends a webhook (incoming SMS/MMS), we look up which tenant owns that number
model PhoneNumberRegistry {
  id                    String   @id @default(cuid())
  phoneNumber           String   @unique // E.164 format: +12345678901
  tenantId              String

  // ====== AUDIT ======
  createdAt             DateTime @default(now())
  releasedAt            DateTime? // Soft-delete when number is released

  // ====== RELATIONS ======
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([tenantId])
  @@index([releasedAt])
}

// ============================================================================
// ADMIN EMAIL INDEX
// ============================================================================
// Fast lookup table for cross-tenant admin email search during login
//
// Problem: When user logs in with email, which tenant database do they belong to?
// Solution: Hash email + store in registry with tenant mapping
//
// Prevents N+1 queries when logging in (would need to connect to every tenant database)
model AdminEmailIndex {
  id                    String   @id @default(cuid())
  emailHash             String   @unique // Hash of admin email (SHA-256)
  tenantId              String   // Which tenant this admin belongs to
  adminId               String   // Admin ID within that tenant

  // ====== AUDIT ======
  createdAt             DateTime @default(now())

  // ====== RELATIONS ======
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([emailHash])
  @@index([tenantId])
  @@index([adminId])
}

// ============================================================================
// AUDIT LOG (Optional - for compliance)
// ============================================================================
// Track important events for compliance and monitoring
model AuditLog {
  id                    String   @id @default(cuid())
  tenantId              String
  action                String   // created, updated, deleted, login_attempt, phone_purchased, etc
  resourceType          String   // tenant, phone_number, admin, etc
  resourceId            String   // ID of resource being audited

  // ====== DETAILS ======
  details               String?  // JSON: { before, after, reason, error, etc }
  ipAddress             String?
  userAgent             String?

  // ====== AUDIT TIMESTAMPS ======
  createdAt             DateTime @default(now())

  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@index([resourceType, resourceId])
}
