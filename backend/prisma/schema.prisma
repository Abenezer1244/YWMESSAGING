// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Church account
model Church {
  id                           String   @id @default(cuid())
  name                         String
  email                        String   @unique
  stripeCustomerId             String?  @unique
  telnyxPhoneNumber            String?
  telnyxNumberSid              String?  @unique
  telnyxWebhookId              String?  // Telnyx webhook ID for MMS events
  telnyxVerified               Boolean  @default(false)
  telnyxPurchasedAt            DateTime?
  // Phase 2: Enterprise linking status tracking
  telnyxPhoneLinkingStatus      String   @default("pending") // pending, linked, failed
  telnyxPhoneLinkingLastAttempt DateTime?
  telnyxPhoneLinkingRetryCount  Int      @default(0) // Tracks retry attempts for automatic recovery
  telnyxPhoneLinkingError       String?  // Last error message for debugging
  // Phase 3: Soft-delete for phone numbers with 30-day recovery window
  telnyxNumberStatus           String   @default("active") // active, archived, pending-deletion
  telnyxNumberDeletedAt        DateTime? // When the number was marked for deletion
  telnyxNumberDeletedBy        String?   // Admin ID who initiated deletion
  telnyxNumberRecoveryDeadline DateTime? // Until this date, number can be restored

  // 10DLC Registration (Delivery Optimization)
  dlcBrandId                   String?  // Telnyx 10DLC brand ID (per-church)
  tcrBrandId                   String?  // The Campaign Registry's brand ID
  dlcStatus                    String   @default("pending") // pending, brand_verified, campaign_pending, approved, rejected, using_shared
  dlcRegisteredAt              DateTime? // When we submitted brand to Telnyx
  dlcApprovedAt                DateTime? // When campaign became MNO_PROVISIONED
  dlcRejectionReason           String?  // If rejected, why
  dlcNextCheckAt               DateTime? // Next time to check approval status
  dlcCampaignId                String?  // Telnyx campaign ID (for tracking campaign approval)
  dlcCampaignStatus            String?  // Campaign status: TCR_PENDING, TELNYX_ACCEPTED, MNO_PROVISIONED, etc.
  dlcNumberAssignedAt          DateTime? // When phone number was assigned to campaign
  dlcCampaignSuspended         Boolean  @default(false) // Campaign suspended due to inactivity
  dlcCampaignSuspendedAt       DateTime? // When campaign was suspended
  dlcCampaignSuspendedReason   String?  // Why campaign was suspended (e.g., "DORMANT")
  usingSharedBrand             Boolean  @default(true) // true = platform brand, false = per-church brand
  deliveryRate                 Float    @default(0.65) // Delivery rate (starts 65% with shared, 99% when approved)

  // 10DLC Brand Information (Required for brand registration with Telnyx)
  ein                          String?  // Employer Identification Number (required for 10DLC)
  brandPhoneNumber             String?  // Brand contact phone number (required for 10DLC)
  streetAddress                String?  // Business street address (required for 10DLC)
  city                         String?  // Business city (required for 10DLC)
  state                        String?  // Business state - 2-letter code (required for 10DLC)
  postalCode                   String?  // Business postal code (required for 10DLC)
  website                      String?  // Church website URL (optional for 10DLC)
  entityType                   String   @default("NON_PROFIT") // Legal entity type (NON_PROFIT, SOLE_PROPRIETOR, PRIVATE_CORPORATION, etc.)
  vertical                     String   @default("RELIGION") // Industry vertical (RELIGION, EDUCATION, HEALTHCARE, etc.)

  trialEndsAt                  DateTime
  subscriptionStatus           String   @default("trial") // trial, active, cancelled, expired
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  // Relations
  branches              Branch[]
  admins                Admin[]
  groups                Group[]
  messages              Message[]
  messageTemplates      MessageTemplate[]
  subscriptions         Subscription[]
  recurringMessages     RecurringMessage[]
  conversations         Conversation[]

  @@index([subscriptionStatus])
  @@index([trialEndsAt])
  @@index([telnyxPhoneNumber])
  @@index([telnyxPhoneLinkingStatus]) // Index for finding churches that need linking
  @@index([telnyxNumberStatus]) // Index for finding archived/deleted numbers
  @@index([telnyxNumberRecoveryDeadline]) // Index for cleanup job to find expired recoveries
  @@index([dlcStatus]) // Index for finding churches pending 10DLC approval
  @@index([dlcNextCheckAt]) // Index for background job to check approval status
}

// Physical locations within a church
model Branch {
  id          String   @id @default(cuid())
  churchId    String
  name        String
  address     String?
  phone       String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  groups      Group[]

  @@index([churchId])
  @@index([isActive])
}

// Groups within a branch (e.g., "Sunday School", "Praise Team")
model Group {
  id                      String   @id @default(cuid())
  branchId                String
  churchId                String
  name                    String
  description             String?
  welcomeMessageEnabled   Boolean  @default(false)
  welcomeMessageText      String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  branch                  Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  church                  Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  members                 GroupMember[]

  @@index([branchId])
  @@index([churchId])
}

// Individual members
model Member {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  phone     String   // ENCRYPTED: E.164 format (encrypted in database)
  phoneHash String?  // Hash of phone for searchable lookups (HMAC-SHA256) - uniqueness handled in application
  email     String?  @unique
  optInSms  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  groups          GroupMember[]
  messageRecipients MessageRecipient[]
  conversations   Conversation[]
  conversationMessages ConversationMessage[]

  @@index([email])
  @@index([phoneHash])
}

// Join table for Group-Member many-to-many
model GroupMember {
  id                  String   @id @default(cuid())
  groupId             String
  memberId            String
  welcomeMessageSent  Boolean  @default(false)
  joinedAt            DateTime @default(now())

  // Relations
  group               Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  member              Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([groupId, memberId])
  @@index([groupId])
  @@index([memberId])
}

// SMS messages sent by church
model Message {
  id                  String   @id @default(cuid())
  churchId            String
  content             String
  status              String   @default("pending") // pending, sent, failed
  targetType          String   // individual, groups, branches, all
  targetIds           String   @default("") // JSON array of IDs
  totalRecipients     Int      @default(0)
  deliveredCount      Int      @default(0)
  failedCount         Int      @default(0)
  sentAt              DateTime?
  createdAt           DateTime @default(now())

  // Relations
  church              Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  recipients          MessageRecipient[]

  @@index([churchId])
  @@index([status])
  @@index([sentAt])
}

// Track delivery status per recipient
model MessageRecipient {
  id                String   @id @default(cuid())
  messageId         String
  memberId          String
  status            String   @default("pending") // pending, sent, delivered, failed
  providerMessageId String?  // Telnyx message ID (generic name for flexibility)
  deliveredAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  // Relations
  message           Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  member            Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([messageId, memberId])
  @@index([messageId])
  @@index([memberId])
  @@index([status])
}

// Reusable message templates
model MessageTemplate {
  id        String   @id @default(cuid())
  churchId  String
  name      String
  content   String
  category  String   // service_reminder, event, prayer, thank_you, welcome, offering
  isDefault Boolean  @default(false)
  usageCount Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([category])
}

// Recurring/scheduled messages
model RecurringMessage {
  id          String   @id @default(cuid())
  churchId    String
  name        String
  content     String
  targetType  String   // individual, groups, branches, all
  targetIds   String   @default("") // JSON array
  frequency   String   // daily, weekly, monthly
  dayOfWeek   Int?     // 0-6 for weekly
  timeOfDay   String?  // HH:MM format
  nextSendAt  DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([isActive])
  @@index([nextSendAt])
}

// Church administrators
model Admin {
  id            String   @id @default(cuid())
  churchId      String
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          String   @default("CO_ADMIN") // PRIMARY, CO_ADMIN
  invitationToken String?
  invitationExpiresAt DateTime?
  lastLoginAt   DateTime?
  welcomeCompleted Boolean @default(false) // Track if user completed onboarding
  userRole      String?  // User's role in the church: pastor, admin, communications, volunteer, other
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  church        Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([role])
}

// Subscription details (Stripe)
model Subscription {
  id              String   @id @default(cuid())
  churchId        String   @unique
  stripeSubId     String?  @unique
  plan            String   @default("starter") // starter, growth, pro
  status          String   @default("active") // active, cancelled, past_due
  currentPeriodStart DateTime?
  currentPeriodEnd DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  church          Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([plan])
  @@index([status])
}

// SMS/MMS Conversations between church and members
model Conversation {
  id              String   @id @default(cuid())
  churchId        String
  memberId        String
  lastMessageAt   DateTime?
  status          String   @default("open")  // open, closed, archived
  unreadCount     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  church          Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  messages        ConversationMessage[]

  @@unique([churchId, memberId])
  @@index([churchId])
  @@index([memberId])
  @@index([lastMessageAt])
  @@index([status])
}

// Individual SMS/MMS messages in conversations
model ConversationMessage {
  id              String   @id @default(cuid())
  conversationId  String
  memberId        String
  content         String   // Text content (can be empty if media-only)
  direction       String   // "inbound" (from member) | "outbound" (from leader)

  // Telnyx tracking
  providerMessageId String?  // Telnyx MMS ID for delivery tracking
  deliveryStatus  String?    // "pending" | "delivered" | "failed"

  // S3 Media fields (full quality, NO compression)
  mediaUrl        String?    // S3 presigned URL (expires in 7 days)
  mediaType       String?    // "image" | "video" | "audio" | "document"
  mediaName       String?    // Original filename
  mediaSizeBytes  Int?       // File size in bytes
  mediaS3Key      String?    // S3 object key for retrieval/deletion
  mediaMimeType   String?    // MIME type (image/jpeg, video/mp4, etc)
  mediaWidth      Int?       // Image width in pixels
  mediaHeight     Int?       // Image height in pixels
  mediaDuration   Int?       // Video/audio duration in seconds

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([direction])
  @@index([mediaType])
  @@index([providerMessageId])
}

// Queue for SMS/MMS messages to be sent
model MessageQueue {
  id                    String   @id @default(cuid())
  churchId              String
  phone                 String   // E.164 format
  content               String   // Text message content
  mediaS3Url            String?  // S3 URL if sending media
  conversationMessageId String?  // Link to conversation message
  status                String   @default("pending")  // pending, sent, failed
  retryCount            Int      @default(0)
  lastError             String?
  sentAt                DateTime?
  failedAt              DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([createdAt])
}

// Analytics events (PostHog backup)
model AnalyticsEvent {
  id        String   @id @default(cuid())
  churchId  String?
  eventName String
  properties String? // JSON
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([eventName])
}

// Chat conversations (public visitors or authenticated users)
model ChatConversation {
  id        String   @id @default(cuid())
  churchId  String?  // null for public landing page visitors
  adminId   String?  // null for public visitors
  visitorId String?  // unique identifier for public visitors (from browser)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages  ChatMessage[]

  @@index([churchId])
  @@index([adminId])
  @@index([visitorId])
}

// Individual chat messages
model ChatMessage {
  id              String   @id @default(cuid())
  conversationId  String
  role            String   // "user" or "assistant"
  content         String
  createdAt       DateTime @default(now())

  // Relations
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}
