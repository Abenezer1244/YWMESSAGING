// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  // ✅ CRITICAL: Connection pooling configuration
  // ✅ PHASE 1: Required for multi-core PM2 clustering
  //
  // DATABASE_URL MUST include these parameters:
  // postgresql://user:password@host/db?connection_limit=30&pool_timeout=45
  //
  // Parameters Explained:
  // - connection_limit=30: Maximum connections (default 2-5, too low for production)
  // - pool_timeout=45: Timeout in seconds before pool returns error
  //
  // Why This Matters:
  // - PM2 cluster mode runs 4-8 Node processes (depending on CPU cores)
  // - Each process has a PrismaClient singleton with its own connection pool
  // - Default limit (2-5) × 4-8 processes = exhaustion at moderate load
  // - Result: "too many connections" errors blocking all requests
  //
  // With Proper Configuration:
  // - Render PostgreSQL pool supports up to 30 concurrent connections
  // - Single shared pool across all processes (handled by Prisma)
  // - Prevents connection exhaustion even at high concurrency
  // - Enables 3-3.5x throughput improvement from clustering
  //
  // Status: ✅ CONFIGURED in .env (line 12)
}

// ============================================================================
// REGISTRY: Church account (main tenant list)
// ============================================================================
// This model is in the REGISTRY database only
// Contains metadata about each church/organization
// Each church has their own isolated database (referenced by Tenant.databaseUrl)
//
model Church {
  id                           String   @id @default(cuid())
  name                         String
  email                        String   @unique
  stripeCustomerId             String?  @unique

  // Telnyx phone number (main registry stores this too for lookups)
  telnyxPhoneNumber            String?
  telnyxNumberSid              String?  @unique
  telnyxWebhookId              String?
  telnyxVerified               Boolean  @default(false)
  telnyxPurchasedAt            DateTime?
  telnyxPhoneLinkingStatus      String   @default("pending")
  telnyxPhoneLinkingLastAttempt DateTime?
  telnyxPhoneLinkingRetryCount  Int      @default(0)
  telnyxPhoneLinkingError       String?
  telnyxNumberStatus           String   @default("active")
  telnyxNumberDeletedAt        DateTime?
  telnyxNumberDeletedBy        String?
  telnyxNumberRecoveryDeadline DateTime?

  // 10DLC Registration
  dlcBrandId                   String?
  tcrBrandId                   String?
  dlcStatus                    String   @default("pending")
  dlcRegisteredAt              DateTime?
  dlcApprovedAt                DateTime?
  dlcRejectionReason           String?
  dlcNextCheckAt               DateTime?
  dlcCampaignId                String?
  dlcCampaignStatus            String?
  dlcNumberAssignedAt          DateTime?
  dlcCampaignSuspended         Boolean  @default(false)
  dlcCampaignSuspendedAt       DateTime?
  dlcCampaignSuspendedReason   String?
  usingSharedBrand             Boolean  @default(true)
  wantsPremiumDelivery         Boolean  @default(false)
  deliveryRate                 Float    @default(0.65)

  // 10DLC Brand Information
  // SECURITY: EIN is encrypted at rest using AES-256-GCM
  ein                          String?   // ✅ Contains encrypted value (iv:salt:encrypted:tag)
  einHash                      String?   // ✅ SHA-256 hash for validation without decryption
  einEncryptedAt               DateTime? // ✅ When EIN was encrypted
  einAccessedAt                DateTime? // ✅ Last access timestamp (audit trail)
  einAccessedBy                String?   // ✅ User ID who last accessed (audit trail)

  brandPhoneNumber             String?
  streetAddress                String?
  city                         String?
  state                        String?
  postalCode                   String?
  website                      String?
  entityType                   String   @default("NON_PROFIT")
  vertical                     String   @default("RELIGION")

  trialEndsAt                  DateTime
  subscriptionStatus           String   @default("trial")
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  // Relations
  tenant                Tenant?         // 1:1 relationship to Tenant (populated when church is ready)

  @@index([subscriptionStatus])
  @@index([trialEndsAt])
  @@index([telnyxPhoneNumber])
  @@index([telnyxPhoneLinkingStatus])
  @@index([telnyxNumberStatus])
  @@index([telnyxNumberRecoveryDeadline])
  @@index([dlcStatus])
  @@index([dlcNextCheckAt])
}
model Tenant {
  id                    String   @id                   // Same as Church.id for 1:1 relationship
  churchId              String   @unique              // Foreign key to Church

  name                  String                        // Church name (denormalized for convenience)
  email                 String   @unique              // Primary admin email (denormalized)

  // Database connection information (encrypted in production)
  databaseUrl           String                        // Full connection string to tenant's isolated database
  databaseHost          String                        // PostgreSQL hostname
  databasePort          Int      @default(5432)       // PostgreSQL port
  databaseName          String                        // Database name

  // Subscription and plan information
  subscriptionStatus    String   @default("trial")    // trial | active | paused | cancelled
  subscriptionPlan      String   @default("starter")  // starter | growth | pro
  trialEndsAt           DateTime?                     // When trial expires

  // Telnyx phone number assignment (one phone number per tenant)
  telnyxPhoneNumber     String?  @unique              // Assigned phone number
  telnyxNumberSid       String?  @unique              // Telnyx resource ID

  // Tenant status lifecycle
  status                String   @default("active")   // active | suspended | archived | deleted
  schemaVersion         String   @default("1.0.0")    // Schema version for tenant database

  // Audit timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastAccessedAt        DateTime @default(now())      // For usage analytics

  // Relations
  church                Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  phoneNumbers          PhoneNumberRegistry[]
  adminEmails           AdminEmailIndex[]

  // Indexes for fast queries
  @@index([churchId])                 // Fast lookup from Church to Tenant
  @@index([telnyxPhoneNumber])        // Fast phone number lookup for incoming SMS/MMS
  @@index([status])                   // Find all active/suspended tenants
  @@index([subscriptionPlan])         // Analytics on plan distribution
  @@index([createdAt])                // Time-based analytics
}

/// Maps phone numbers to tenants for incoming SMS/MMS routing
///
/// Purpose: Route incoming SMS/MMS to correct tenant database
///
/// When Telnyx sends incoming SMS/MMS to a phone number:
/// 1. Look up phone number in this registry
/// 2. Get tenantId from the registry
/// 3. Get tenant database connection
/// 4. Route message to correct database
///
/// One phone number = One tenant (exclusive ownership)
model PhoneNumberRegistry {
  id          String   @id @default(cuid())
  phoneNumber String   @unique                  // E.164 format: +14155552671
  tenantId    String

  // Audit trail
  registeredAt DateTime @default(now())        // When phone was registered
  assignedAt   DateTime @default(now())        // When assigned to tenant

  // Relation to tenant
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([phoneNumber])                        // Fast lookup by phone number
  @@index([tenantId])                           // Find all numbers for a tenant
  @@index([registeredAt])                       // Time-based analytics
}

/// Fast lookup: Email → Tenant mapping for login flow
///
/// Purpose: During login, find which tenant/database contains this admin email
///
/// Flow:
/// 1. User enters email + password on login page
/// 2. Query this table: "Which tenant has this email?"
/// 3. Get tenantId and its database connection string
/// 4. Connect to that tenant's database
/// 5. Verify password against admin record in tenant database
///
/// Email hash used for privacy (store hash instead of plain email in registry)
model AdminEmailIndex {
  id        String   @id @default(cuid())
  emailHash String   @unique                  // Hash of admin email for privacy
  email     String   @unique                  // Plain email (encrypted in DB)
  tenantId  String                            // Which tenant this admin belongs to
  adminId   String                            // Admin ID in tenant's database

  // Audit trail
  createdAt DateTime @default(now())

  // Relation to tenant
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([emailHash])                        // Fast hash-based lookup
  @@index([email])                            // Support plain email queries too
  @@index([tenantId])                         // Find all admins for a tenant
}
