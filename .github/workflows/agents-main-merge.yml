name: Automated Agent Post-Merge Analysis

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '.md'
      - '.github/workflows/agents-scheduled.yml'

jobs:
  architecture-review:
    runs-on: ubuntu-latest
    name: System Architecture Review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Invoke System Architecture Agent
        run: |
          echo "üèóÔ∏è Invoking System Architecture Agent for commit ${{ github.sha }}"
          curl -X POST ${{ secrets.CLAUDE_WEBHOOK_URL }} \
            -H "Authorization: Bearer ${{ secrets.CLAUDE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "agent": "system-architecture",
              "event_type": "push",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            }'

  devops-review:
    runs-on: ubuntu-latest
    name: DevOps Readiness Review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Invoke DevOps Agent
        run: |
          echo "üöÄ Invoking DevOps Agent for commit ${{ github.sha }}"
          curl -X POST ${{ secrets.CLAUDE_WEBHOOK_URL }} \
            -H "Authorization: Bearer ${{ secrets.CLAUDE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "agent": "devops",
              "event_type": "push",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            }'

  product-update:
    runs-on: ubuntu-latest
    name: Product Strategy Update
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Invoke Product Manager Agent
        run: |
          echo "üìä Invoking Product Manager Agent for commit ${{ github.sha }}"
          curl -X POST ${{ secrets.CLAUDE_WEBHOOK_URL }} \
            -H "Authorization: Bearer ${{ secrets.CLAUDE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "agent": "product-manager",
              "event_type": "push",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            }'

  summary:
    runs-on: ubuntu-latest
    name: Post-Merge Analysis Summary
    needs: [architecture-review, devops-review, product-update]
    if: always()
    steps:
      - name: Create GitHub Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const archStatus = '${{ needs.architecture-review.result }}';
            const devopsStatus = '${{ needs.devops-review.result }}';
            const productStatus = '${{ needs.product-update.result }}';

            const summary = `## ü§ñ Post-Merge Agent Analysis

| Agent | Status |
|-------|--------|
| üèóÔ∏è System Architecture | ${archStatus === 'success' ? '‚úÖ' : archStatus === 'failure' ? '‚ùå' : '‚è≥'} ${archStatus} |
| üöÄ DevOps | ${devopsStatus === 'success' ? '‚úÖ' : devopsStatus === 'failure' ? '‚ùå' : '‚è≥'} ${devopsStatus} |
| üìä Product Manager | ${productStatus === 'success' ? '‚úÖ' : productStatus === 'failure' ? '‚ùå' : '‚è≥'} ${productStatus} |

**Commit:** \`${{ github.sha }}\`
**Message:** ${{ github.event.head_commit.message }}

Detailed analysis reports available in logs.

_Generated by Automated Agent Analysis System_`;

            console.log(summary);
