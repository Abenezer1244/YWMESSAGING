; ============================================================================
; PgBouncer Configuration
; ✅ PHASE 2: Connection pooling for PostgreSQL
; ============================================================================
;
; PgBouncer sits between application and PostgreSQL, pooling connections
; to prevent "too many connections" errors under high load.
;
; Topology:
;   Applications → PgBouncer (port 6432) → PostgreSQL (port 5432)
;
; Benefits:
;   - 30 DB connections → 300+ concurrent clients (10x increase)
;   - Automatic connection reuse
;   - Transaction mode isolates connections properly for ORM
;   - Minimal latency overhead (<5ms)

[databases]
; Connection string for the PostgreSQL database
; Format: host=<hostname> port=5432 dbname=<dbname>
connect_yw_production = host=dpg-d41af09r0fns73c9i010-a.oregon-postgres.render.com port=5432 dbname=connect_yw_production


[pgbouncer]
; ============================================================================
; POOLING SETTINGS
; ============================================================================

; Connection pooling mode
; - session: one server connection per client session (safe, less reuse)
; - transaction: one server connection per transaction (recommended for Prisma)
; - statement: one server connection per statement (maximum reuse, risky)
pool_mode = transaction

; Number of connections PgBouncer can accept (client limit)
max_client_conn = 1000

; Number of servers connections to keep open per database
; Higher = more memory, better response time
; Lower = less memory, potential latency
; Render PostgreSQL supports up to 30 connections, set default to 30
default_pool_size = 30

; Minimum number to keep open
min_pool_size = 10

; Extra connections to create for performance
reserve_pool_size = 5

; Maximum time to wait for a server connection from the pool
; If exceeded, disconnect the client
reserve_pool_timeout = 3

; Maximum number of connections per (database, user) pair
max_db_connections = 100

; Maximum number of connections per user
max_user_connections = 100

; Server connection lifetime
# Kill connections after this many seconds
server_lifetime = 3600

; Idle timeout before disconnecting
; Keeps connections fresh and prevents TCP issues
server_idle_timeout = 600

; How often to check server connections for idleness
autodb_idle_timeout = 10

; Queries taking longer than this are logged (in milliseconds)
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

; Enable statistics collection
; Use for monitoring connection reuse efficiency
stats_period = 60


; ============================================================================
; SECURITY SETTINGS
; ============================================================================

; Listen on this interface
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication file - contains username/password pairs
auth_file = /etc/pgbouncer/userlist.txt

; Authentication method
; md5 = MD5 password hashing
; plain = plaintext (not recommended)
auth_type = md5

; Enable query logging
; WARNING: Can be verbose, only enable in development
# query_wait_timeout = 120


; ============================================================================
; ADMINISTRATIVE SETTINGS
; ============================================================================

; Admin interface - for monitoring
admin_users = pgbouncer

; Connection string for admin interface
; Can connect to pgbouncer as "psql -h localhost -p 6432 -U pgbouncer pgbouncer"
; Then run: SHOW STATS, SHOW POOLS, SHOW CLIENTS, SHOW SERVERS

; PgBouncer database for admin functions
; This is a virtual database containing admin tables
pga_enabled = true


; ============================================================================
; LOGGING SETTINGS
; ============================================================================

; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

; Log level
; - debug: verbose logging
; - info: normal logging
; - warning: warnings only
; - error: errors only
loglevel = info

; Facility for syslog
# syslog_facility = local0


; ============================================================================
; ADVANCED TUNING
; ============================================================================

; Maximum time for server response to a query (seconds)
query_timeout = 0

; Maximum query duration before cancel (seconds)
; 0 = disabled
query_wait_timeout = 120

; Client request timeout (seconds)
client_idle_timeout = 3600

; Idle server timeout (seconds)
server_idle_timeout = 600

; Connection pool timeout (seconds)
pool_timeout = 45

; Maximum memory usage
; PgBouncer will shut down if exceeded
max_memory_usage = 0

; Maximum number of events in event queue
; Increase if seeing "queue full" errors
event_buf_size = 2048

; ============================================================================
; SPECIFIC DATABASE OVERRIDES
; ============================================================================
; Format: database_name_pool_size = 50
; Format: database_name_min_pool_size = 10

; Example for high-traffic databases:
# connect_yw_production_pool_size = 50
# connect_yw_production_min_pool_size = 20


; ============================================================================
; NOTES FOR PRODUCTION
; ============================================================================
;
; 1. Replication:
;    - If using streaming replication, PgBouncer should sit in front of primary only
;    - Create separate PgBouncer instances for read replicas
;
; 2. Monitoring:
;    - Monitor connection reuse ratio (target: 90%+ reuse)
;    - Monitor query latency (should add <5ms)
;    - Monitor pool saturation (should not exceed 80%)
;
; 3. Tuning:
;    - Increase default_pool_size if seeing "no more connections" errors
;    - Decrease if seeing high memory usage
;    - Use "SHOW STATS" command to monitor performance
;
; 4. HA Setup:
;    - Run 2 PgBouncer instances behind load balancer
;    - Both point to same PostgreSQL primary
;    - Provides redundancy if one PgBouncer fails
;
; 5. Migration:
;    - Gradually shift traffic from direct DB connection to PgBouncer
;    - Update backend DATABASE_URL to point to PgBouncer port 6432
;    - Monitor for issues before full migration
