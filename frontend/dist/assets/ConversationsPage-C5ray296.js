import{c as R,r as l,j as e,R as _,I as A,S as H,a as Q,_ as w}from"./index-COi7WSCt.js";import{L as E,S as F,a as Y}from"./SoftLayout-LtuyLVOD.js";import{S as k}from"./SoftButton-VCfGeL98.js";import{m as S}from"./proxy-BNDPvGaM.js";import{c as T,M as U,X as I}from"./index-Dtr1r6A2.js";import{C as J}from"./circle-alert-CW9lVKIX.js";import{S as X}from"./send-sBZp5aEb.js";import{P as G}from"./phone-Dnya_y7O.js";/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],ee=T("archive",Z);/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],te=T("download",se);/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],B=T("paperclip",ae);async function re(s={}){const t=new URLSearchParams;return s.page&&t.append("page",s.page.toString()),s.limit&&t.append("limit",s.limit.toString()),s.status&&t.append("status",s.status),(await R.get(`/messages/conversations?${t.toString()}`)).data}async function L(s,t={}){const n=new URLSearchParams;return t.page&&n.append("page",t.page.toString()),t.limit&&n.append("limit",t.limit.toString()),(await R.get(`/messages/conversations/${s}?${n.toString()}`)).data}async function ne(s){await R.patch(`/messages/conversations/${s}/read`)}async function ie(s,t){return(await R.patch(`/messages/conversations/${s}/status`,{status:t})).data}function oe({conversation:s,isSelected:t,onSelect:n,onUpdateStatus:i,index:o}){const a=x=>{const u=new Date(x),f=new Date,p=(f.getTime()-u.getTime())/(1e3*60*60);return p<1?`${Math.floor((f.getTime()-u.getTime())/6e4)}m ago`:p<24?`${Math.floor(p)}h ago`:u.toLocaleDateString([],{month:"short",day:"numeric"})},c=x=>{switch(x){case"open":return"bg-blue-500/20 text-blue-400";case"closed":return"bg-red-500/20 text-red-400";case"archived":return"bg-gray-500/20 text-gray-400";default:return"bg-muted text-muted-foreground"}};return e.jsx(S.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:o*.05},children:e.jsx("button",{onClick:()=>n(s.id),className:`w-full text-left p-4 rounded-lg border transition-all duration-200 ${t?"border-primary bg-primary/5":"border-border/40 bg-card/50 hover:border-border hover:bg-card"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[s.unreadCount>0&&e.jsx("div",{className:"mt-1 flex-shrink-0",children:e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold text-foreground truncate",children:[s.member.firstName," ",s.member.lastName]}),s.unreadCount>0&&e.jsx("span",{className:"bg-primary/20 text-primary text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0",children:s.unreadCount})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate mb-2",children:s.member.phone}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded ${c(s.status)}`,children:s.status}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a(s.lastMessageAt)})]})]}),t&&i&&e.jsx("div",{className:"flex-shrink-0 flex gap-1",onClick:x=>x.stopPropagation(),children:s.status!=="archived"&&e.jsx(k,{variant:"secondary",size:"sm",onClick:()=>{i(s.id,"archived")},className:"p-2",children:e.jsx(ee,{className:"w-4 h-4"})})})]})})})}const le=l.memo(oe),{FixedSizeList:ce}=require("react-window"),de=_.memo(function({index:t,style:n,data:i}){const{conversations:o,selectedConversationId:a,onSelectConversation:c,onUpdateStatus:x}=i,u=o[t];return e.jsx("div",{style:n,children:e.jsx("div",{className:"px-2",children:e.jsx(le,{conversation:u,isSelected:a===u.id,onSelect:c,onUpdateStatus:x,index:t})})})});function me({conversations:s,selectedConversationId:t,onSelectConversation:n,onUpdateStatus:i,isLoading:o=!1,containerHeight:a=600}){const c=l.useMemo(()=>({conversations:s,selectedConversationId:t,onSelectConversation:n,onUpdateStatus:i}),[s,t,n,i]);return o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(S.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-6 h-6 text-primary"})})}):s.length===0?e.jsxs(F,{className:"text-center py-12",children:[e.jsx(U,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No Conversations"}),e.jsx("p",{className:"text-muted-foreground",children:"Conversations will appear here when members text your church number"})]}):e.jsx(ce,{height:a,itemCount:s.length,itemSize:88,width:"100%",itemData:c,overscanCount:5,children:de})}const O=_.forwardRef(({src:s,alt:t,fallback:n,onLoad:i,onError:o,className:a,style:c,...x},u)=>{const f=l.useRef(null),[p,j]=l.useState(!1),[d,b]=l.useState(!1);return l.useEffect(()=>{const y=f.current;if(y)if("IntersectionObserver"in window){const h=new IntersectionObserver(N=>{N.forEach(r=>{r.isIntersecting&&(y.src=s,h.unobserve(y),y.onload=()=>{j(!0),i?.()},y.onerror=()=>{b(!0),o?.()})})},{rootMargin:"50px"});return h.observe(y),()=>{h.disconnect()}}else y.src=s,j(!0)},[s,i,o]),e.jsx("img",{ref:f,alt:t,className:`${a||""} ${!p&&n?"blur-sm":""}`,style:{transition:"filter 0.3s ease-in-out",...c},"data-src":s,src:n||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"%3E%3Crect fill="%23f0f0f0" width="400" height="300"/%3E%3C/svg%3E',loading:"lazy",...x})});O.displayName="LazyImage";function ue(s){const{content:t,direction:n,memberName:i,deliveryStatus:o,mediaUrl:a,mediaType:c,mediaName:x,mediaSizeBytes:u,mediaDuration:f,createdAt:p}=s,j=n==="outbound",d=h=>{if(!h)return"";const N=h/1024/1024;return N>1?`${N.toFixed(1)}MB`:`${(h/1024).toFixed(0)}KB`},b=h=>{if(!h)return"";const N=Math.floor(h/60),r=h%60;return`${N}:${r.toString().padStart(2,"0")}`},y=new Date(p).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsx("div",{className:`flex ${j?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`max-w-sm rounded-lg p-3 ${j?"bg-primary text-white":"bg-muted text-foreground"}`,children:[!j&&i&&e.jsx("p",{className:"text-xs font-semibold mb-1 opacity-75",children:i}),a&&c==="image"&&e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block mb-2",children:e.jsx(O,{src:a,alt:"Message attachment",className:"max-w-xs rounded-lg hover:opacity-90 cursor-pointer"})}),a&&c==="video"&&e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block mb-2 relative",children:e.jsxs("video",{className:"max-w-xs rounded-lg",controls:!0,poster:a,children:[e.jsx("source",{src:a,type:"video/mp4"}),"Your browser does not support the video tag."]})}),a&&c==="audio"&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("audio",{controls:!0,className:"max-w-xs rounded-lg",children:[e.jsx("source",{src:a,type:"audio/mpeg"}),"Your browser does not support the audio element."]}),f&&e.jsx("p",{className:"text-xs mt-1 opacity-75",children:b(f)})]}),a&&c==="document"&&e.jsxs("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 rounded-lg mb-2 ${j?"bg-white/20 hover:bg-white/30":"bg-foreground/10 hover:bg-foreground/20"}`,children:[e.jsx("span",{children:"ðŸ“„"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:x}),u&&e.jsx("p",{className:"text-xs opacity-75",children:d(u)})]}),e.jsx(te,{size:16,className:"flex-shrink-0"})]}),t&&!t.startsWith("[")&&e.jsx("p",{className:"text-sm break-words whitespace-pre-wrap",children:t}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mt-1",children:[e.jsx("p",{className:`text-xs ${j?"text-white/80":"text-muted-foreground"}`,children:y}),j&&o&&e.jsxs("span",{className:"text-xs opacity-75",children:[o==="pending"&&"â±ï¸",o==="delivered"&&"âœ“âœ“",o==="failed"&&"âŒ"]})]})]})})}const xe=l.memo(ue);function fe({conversation:s,messages:t,isLoading:n=!1,page:i=1,pages:o=1,onLoadMore:a}){const c=l.useRef(null),x=l.useRef(null),u=()=>{c.current?.scrollIntoView({behavior:"smooth"})};return l.useEffect(()=>{i===o&&u()},[t,i,o]),!t.length&&!n?e.jsx("div",{className:"flex flex-col items-center justify-center h-full py-12 text-center",children:e.jsxs("div",{className:"text-muted-foreground",children:[e.jsx("p",{className:"text-lg font-medium mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"This conversation is just getting started. Send a message to get started!"})]})}):e.jsx("div",{className:"flex flex-col h-full",children:e.jsxs("div",{ref:x,className:"flex-1 overflow-y-auto px-4 py-6 space-y-4",children:[i<o&&e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(k,{variant:"secondary",size:"sm",onClick:()=>a?.(i+1),disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(S.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-4 h-4 inline mr-2"})}),"Loading..."]}):"Load Older Messages"})}),t.map(f=>e.jsx(xe,{...f},f.id)),n&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(S.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-6 h-6 text-primary"})})}),e.jsx("div",{ref:c})]})})}function he({conversationId:s,onReply:t,isLoading:n}){const[i,o]=l.useState(""),[a,c]=l.useState(null),[x,u]=l.useState(null),[f,p]=l.useState(!1),[j,d]=l.useState(null),b=l.useRef(null),y=async r=>{const g=r.target.files?.[0];if(!g)return;d(null);const C=500*1024*1024;if(g.size>C){d(`File too large. Max 500MB, got ${(g.size/1024/1024).toFixed(1)}MB`);return}if(!["image/jpeg","image/png","image/gif","image/webp","video/mp4","video/quicktime","video/x-msvideo","video/x-matroska","audio/mpeg","audio/wav","audio/aac","audio/ogg","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(g.type)){d(`File type not allowed: ${g.type}`);return}if(c(g),g.type.startsWith("image/")){const $=new FileReader;$.onload=z=>{u(z.target?.result)},$.readAsDataURL(g)}else u(null)},h=async()=>{if(!(!i&&!a))if(d(null),a){p(!0);try{const r=new FormData;r.append("file",a),i&&r.append("content",i);const g=await fetch(`/api/messages/conversations/${s}/reply-with-media`,{method:"POST",body:r});if(!g.ok){const C=await g.json();throw new Error(C.error||"Failed to send message with media")}o(""),c(null),u(null),b.current&&(b.current.value=""),await t("")}catch(r){console.error("Upload error:",r),d(r instanceof Error?r.message:"Failed to send media")}finally{p(!1)}}else try{const r=await fetch(`/api/messages/conversations/${s}/reply`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:i})});if(!r.ok){const g=await r.json();throw new Error(g.error||"Failed to send message")}o(""),await t("")}catch(r){console.error("Send error:",r),d(r instanceof Error?r.message:"Failed to send message")}},N=r=>{if(!r)return"";const g=r/1024/1024;return g>1?`${g.toFixed(1)}MB`:`${(r/1024).toFixed(0)}KB`};return e.jsxs("div",{className:"bg-card border-t border-border p-4",children:[j&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-3 bg-red-500/10 text-red-600 rounded-lg",children:[e.jsx(J,{size:16,className:"flex-shrink-0"}),e.jsx("p",{className:"text-sm",children:j}),e.jsx("button",{onClick:()=>d(null),className:"ml-auto text-red-600 hover:text-red-700",children:e.jsx(I,{size:16})})]}),x&&e.jsxs("div",{className:"mb-3 relative inline-block",children:[e.jsx("img",{src:x,alt:"Preview",className:"max-h-40 rounded-lg border border-border"}),e.jsx("button",{onClick:()=>{c(null),u(null),b.current&&(b.current.value="")},className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(I,{size:16})})]}),a&&!x&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-2 bg-muted rounded-lg",children:[e.jsx(B,{size:16,className:"text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm text-foreground flex-1 truncate",children:a.name}),e.jsx("button",{onClick:()=>{c(null),b.current&&(b.current.value="")},className:"text-red-500 hover:text-red-600 flex-shrink-0",children:e.jsx(I,{size:16})})]}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("input",{ref:b,type:"file",onChange:y,style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",disabled:f||n}),e.jsx("div",{title:"Attach file (image, video, audio, document)",children:e.jsx(k,{variant:"secondary",size:"md",onClick:()=>b.current?.click(),disabled:f||n,className:"flex-shrink-0",children:e.jsx(B,{size:18})})}),e.jsx(A,{placeholder:a?"Add a caption (optional)...":"Type a message...",value:i,onChange:r=>o(r.target.value),disabled:f||n,onKeyPress:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),h())},className:"flex-1"}),e.jsx(k,{variant:"primary",size:"md",onClick:h,disabled:!i&&!a||f||n,className:"flex-shrink-0",children:f||n?e.jsx(H,{size:"sm"}):e.jsx(X,{size:18})})]}),a&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:[N(a.size)," â€¢ Will be sent at full quality"]})]})}function Se(){Q();const[s,t]=l.useState([]),[n,i]=l.useState(!0),[o,a]=l.useState(1),[c,x]=l.useState(1),[u,f]=l.useState(""),[p,j]=l.useState(null),[d,b]=l.useState(null),[y,h]=l.useState([]),[N,r]=l.useState(!1),[g,C]=l.useState(1),[P,$]=l.useState(1);l.useEffect(()=>{z()},[o,u]);const z=async()=>{try{i(!0);const m=await re({page:o,limit:20});t(m.data),x(m.pagination.pages),p&&!m.data.find(v=>v.id===p)&&(j(null),b(null),h([]))}catch(m){w.error(m.message||"Failed to load conversations")}finally{i(!1)}},q=async m=>{try{j(m),r(!0),C(1);const v=await L(m,{page:1,limit:50});b(v.conversation),h(v.messages.reverse()),$(v.pagination.pages),await ne(m)}catch(v){w.error(v.message||"Failed to load conversation"),j(null)}finally{r(!1)}},K=async m=>{if(p)try{r(!0);const v=await L(p,{page:m,limit:50});h(M=>[...v.messages.reverse(),...M]),C(m)}catch(v){w.error(v.message||"Failed to load messages")}finally{r(!1)}},V=async()=>{if(p)try{const m=await L(p,{page:P,limit:50});h(v=>[...v,...m.messages.reverse()]),await z(),w.success("Message sent")}catch(m){w.error(m.message||"Failed to send message")}},W=async(m,v)=>{try{await ie(m,v),t(M=>M.map(D=>D.id===m?{...D,status:v}:D)),d?.id===m&&b({...d,status:v}),w.success(`Conversation ${v}`)}catch(M){w.error(M.message||"Failed to update conversation")}};return e.jsx(Y,{children:e.jsxs("div",{className:"px-4 md:px-8 py-8 w-full h-full flex flex-col",children:[e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-8",children:[e.jsx("div",{className:"flex items-start justify-between mb-6 flex-wrap gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground mb-2",children:e.jsx("span",{className:"bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Conversations"})}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"}),"Members text your church number to start conversations"]})]})}),e.jsx("div",{className:"flex gap-4 items-center",children:e.jsx(A,{type:"text",placeholder:"Search by name or phone...",value:u,onChange:m=>{f(m.target.value),a(1)},className:"flex-1 min-w-xs"})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0",children:[e.jsx(S.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5},className:"lg:col-span-1 flex flex-col min-h-0",children:e.jsxs(F,{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("h2",{className:"font-semibold text-foreground",children:[s.length," Conversations"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx("div",{className:"p-4",children:e.jsx(me,{conversations:s,selectedConversationId:p||void 0,onSelectConversation:q,onUpdateStatus:W,isLoading:n})})}),c>1&&e.jsxs("div",{className:"p-4 border-t border-border/40 flex justify-between gap-2",children:[e.jsx(k,{variant:"secondary",size:"sm",onClick:()=>a(Math.max(1,o-1)),disabled:o===1,children:"Previous"}),e.jsxs("span",{className:"text-xs text-muted-foreground self-center",children:["Page ",o," of ",c]}),e.jsx(k,{variant:"secondary",size:"sm",onClick:()=>a(Math.min(c,o+1)),disabled:o===c,children:"Next"})]})]})}),e.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"lg:col-span-2 flex flex-col min-h-0",children:d?e.jsxs(F,{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-foreground",children:[d.member.firstName," ",d.member.lastName]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:d.member.phone})]}),e.jsx("span",{className:`text-xs font-medium px-3 py-1 rounded ${d.status==="open"?"bg-blue-500/20 text-blue-400":d.status==="closed"?"bg-red-500/20 text-red-400":"bg-gray-500/20 text-gray-400"}`,children:d.status})]})}),e.jsx(fe,{conversation:d,messages:y,isLoading:N,page:g,pages:P,onLoadMore:K}),e.jsx(he,{conversationId:d.id,onReply:V})]}):e.jsx(F,{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(U,{className:"w-16 h-16 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the list to view and reply to messages"})]})})})]})]})})}export{Se as ConversationsPage,Se as default};
//# sourceMappingURL=ConversationsPage-C5ray296.js.map
