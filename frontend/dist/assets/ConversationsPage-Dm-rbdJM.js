import{c as P,j as e,r as m,I as A,S as V,a as W,_ as N}from"./index-CYlBanuv.js";import{L as E,S as z,a as H}from"./SoftLayout-Cp1fW9yb.js";import{S as C}from"./SoftButton-B8r8nbgw.js";import{m as w}from"./proxy-dvsqPYZm.js";import{c as _,M as I,X as R}from"./index-JGUmpJJ5.js";import{C as Q}from"./circle-alert-DdlW01CV.js";import{S as Y}from"./send-CjhvXA4K.js";import{P as J}from"./phone-DQr_8uBx.js";/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],G=_("archive",X);/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],ee=_("download",Z);/**
 * @license lucide-react v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],B=_("paperclip",se);async function te(n={}){const r=new URLSearchParams;return n.page&&r.append("page",n.page.toString()),n.limit&&r.append("limit",n.limit.toString()),n.status&&r.append("status",n.status),(await P.get(`/messages/conversations?${r.toString()}`)).data}async function L(n,r={}){const i=new URLSearchParams;return r.page&&i.append("page",r.page.toString()),r.limit&&i.append("limit",r.limit.toString()),(await P.get(`/messages/conversations/${n}?${i.toString()}`)).data}async function ae(n){await P.patch(`/messages/conversations/${n}/read`)}async function re(n,r){return(await P.patch(`/messages/conversations/${n}/status`,{status:r})).data}function ne({conversations:n,selectedConversationId:r,onSelectConversation:i,onUpdateStatus:d,isLoading:o=!1}){const t=a=>{const u=new Date(a),f=new Date,g=(f.getTime()-u.getTime())/(1e3*60*60);return g<1?`${Math.floor((f.getTime()-u.getTime())/6e4)}m ago`:g<24?`${Math.floor(g)}h ago`:u.toLocaleDateString([],{month:"short",day:"numeric"})},x=a=>{switch(a){case"open":return"bg-blue-500/20 text-blue-400";case"closed":return"bg-red-500/20 text-red-400";case"archived":return"bg-gray-500/20 text-gray-400";default:return"bg-muted text-muted-foreground"}};return o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(w.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-6 h-6 text-primary"})})}):n.length===0?e.jsxs(z,{className:"text-center py-12",children:[e.jsx(I,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No Conversations"}),e.jsx("p",{className:"text-muted-foreground",children:"Conversations will appear here when members text your church number"})]}):e.jsx("div",{className:"space-y-2",children:n.map((a,u)=>e.jsx(w.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:u*.05},children:e.jsx("button",{onClick:()=>i(a.id),className:`w-full text-left p-4 rounded-lg border transition-all duration-200 ${r===a.id?"border-primary bg-primary/5":"border-border/40 bg-card/50 hover:border-border hover:bg-card"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[a.unreadCount>0&&e.jsx("div",{className:"mt-1 flex-shrink-0",children:e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold text-foreground truncate",children:[a.member.firstName," ",a.member.lastName]}),a.unreadCount>0&&e.jsx("span",{className:"bg-primary/20 text-primary text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0",children:a.unreadCount})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate mb-2",children:a.member.phone}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded ${x(a.status)}`,children:a.status}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t(a.lastMessageAt)})]})]}),r===a.id&&d&&e.jsx("div",{className:"flex-shrink-0 flex gap-1",onClick:f=>f.stopPropagation(),children:a.status!=="archived"&&e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>{d(a.id,"archived")},className:"p-2",children:e.jsx(G,{className:"w-4 h-4"})})})]})})},a.id))})}function ie(n){const{content:r,direction:i,memberName:d,deliveryStatus:o,mediaUrl:t,mediaType:x,mediaName:a,mediaSizeBytes:u,mediaDuration:f,createdAt:g}=n,v=i==="outbound",c=j=>{if(!j)return"";const b=j/1024/1024;return b>1?`${b.toFixed(1)}MB`:`${(j/1024).toFixed(0)}KB`},y=j=>{if(!j)return"";const b=Math.floor(j/60),s=j%60;return`${b}:${s.toString().padStart(2,"0")}`},k=new Date(g).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsx("div",{className:`flex ${v?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`max-w-sm rounded-lg p-3 ${v?"bg-primary text-white":"bg-muted text-foreground"}`,children:[!v&&d&&e.jsx("p",{className:"text-xs font-semibold mb-1 opacity-75",children:d}),t&&x==="image"&&e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"block mb-2",children:e.jsx("img",{src:t,alt:"Message attachment",className:"max-w-xs rounded-lg hover:opacity-90 cursor-pointer"})}),t&&x==="video"&&e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"block mb-2 relative",children:e.jsxs("video",{className:"max-w-xs rounded-lg",controls:!0,poster:t,children:[e.jsx("source",{src:t,type:"video/mp4"}),"Your browser does not support the video tag."]})}),t&&x==="audio"&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("audio",{controls:!0,className:"max-w-xs rounded-lg",children:[e.jsx("source",{src:t,type:"audio/mpeg"}),"Your browser does not support the audio element."]}),f&&e.jsx("p",{className:"text-xs mt-1 opacity-75",children:y(f)})]}),t&&x==="document"&&e.jsxs("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 rounded-lg mb-2 ${v?"bg-white/20 hover:bg-white/30":"bg-foreground/10 hover:bg-foreground/20"}`,children:[e.jsx("span",{children:"ðŸ“„"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a}),u&&e.jsx("p",{className:"text-xs opacity-75",children:c(u)})]}),e.jsx(ee,{size:16,className:"flex-shrink-0"})]}),r&&!r.startsWith("[")&&e.jsx("p",{className:"text-sm break-words whitespace-pre-wrap",children:r}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mt-1",children:[e.jsx("p",{className:`text-xs ${v?"text-white/80":"text-muted-foreground"}`,children:k}),v&&o&&e.jsxs("span",{className:"text-xs opacity-75",children:[o==="pending"&&"â±ï¸",o==="delivered"&&"âœ“âœ“",o==="failed"&&"âŒ"]})]})]})})}function oe({conversation:n,messages:r,isLoading:i=!1,page:d=1,pages:o=1,onLoadMore:t}){const x=m.useRef(null),a=m.useRef(null),u=()=>{x.current?.scrollIntoView({behavior:"smooth"})};return m.useEffect(()=>{d===o&&u()},[r,d,o]),!r.length&&!i?e.jsx("div",{className:"flex flex-col items-center justify-center h-full py-12 text-center",children:e.jsxs("div",{className:"text-muted-foreground",children:[e.jsx("p",{className:"text-lg font-medium mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"This conversation is just getting started. Send a message to get started!"})]})}):e.jsx("div",{className:"flex flex-col h-full",children:e.jsxs("div",{ref:a,className:"flex-1 overflow-y-auto px-4 py-6 space-y-4",children:[d<o&&e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>t?.(d+1),disabled:i,children:i?e.jsxs(e.Fragment,{children:[e.jsx(w.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-4 h-4 inline mr-2"})}),"Loading..."]}):"Load Older Messages"})}),r.map(f=>e.jsx(ie,{...f},f.id)),i&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(w.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(E,{className:"w-6 h-6 text-primary"})})}),e.jsx("div",{ref:x})]})})}function le({conversationId:n,onReply:r,isLoading:i}){const[d,o]=m.useState(""),[t,x]=m.useState(null),[a,u]=m.useState(null),[f,g]=m.useState(!1),[v,c]=m.useState(null),y=m.useRef(null),k=async s=>{const p=s.target.files?.[0];if(!p)return;c(null);const S=500*1024*1024;if(p.size>S){c(`File too large. Max 500MB, got ${(p.size/1024/1024).toFixed(1)}MB`);return}if(!["image/jpeg","image/png","image/gif","image/webp","video/mp4","video/quicktime","video/x-msvideo","video/x-matroska","audio/mpeg","audio/wav","audio/aac","audio/ogg","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(p.type)){c(`File type not allowed: ${p.type}`);return}if(x(p),p.type.startsWith("image/")){const $=new FileReader;$.onload=F=>{u(F.target?.result)},$.readAsDataURL(p)}else u(null)},j=async()=>{if(!(!d&&!t))if(c(null),t){g(!0);try{const s=new FormData;s.append("file",t),d&&s.append("content",d);const p=await fetch(`/api/messages/conversations/${n}/reply-with-media`,{method:"POST",body:s});if(!p.ok){const S=await p.json();throw new Error(S.error||"Failed to send message with media")}o(""),x(null),u(null),y.current&&(y.current.value=""),await r("")}catch(s){console.error("Upload error:",s),c(s instanceof Error?s.message:"Failed to send media")}finally{g(!1)}}else try{const s=await fetch(`/api/messages/conversations/${n}/reply`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:d})});if(!s.ok){const p=await s.json();throw new Error(p.error||"Failed to send message")}o(""),await r("")}catch(s){console.error("Send error:",s),c(s instanceof Error?s.message:"Failed to send message")}},b=s=>{if(!s)return"";const p=s/1024/1024;return p>1?`${p.toFixed(1)}MB`:`${(s/1024).toFixed(0)}KB`};return e.jsxs("div",{className:"bg-card border-t border-border p-4",children:[v&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-3 bg-red-500/10 text-red-600 rounded-lg",children:[e.jsx(Q,{size:16,className:"flex-shrink-0"}),e.jsx("p",{className:"text-sm",children:v}),e.jsx("button",{onClick:()=>c(null),className:"ml-auto text-red-600 hover:text-red-700",children:e.jsx(R,{size:16})})]}),a&&e.jsxs("div",{className:"mb-3 relative inline-block",children:[e.jsx("img",{src:a,alt:"Preview",className:"max-h-40 rounded-lg border border-border"}),e.jsx("button",{onClick:()=>{x(null),u(null),y.current&&(y.current.value="")},className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(R,{size:16})})]}),t&&!a&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-2 bg-muted rounded-lg",children:[e.jsx(B,{size:16,className:"text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm text-foreground flex-1 truncate",children:t.name}),e.jsx("button",{onClick:()=>{x(null),y.current&&(y.current.value="")},className:"text-red-500 hover:text-red-600 flex-shrink-0",children:e.jsx(R,{size:16})})]}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("input",{ref:y,type:"file",onChange:k,style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",disabled:f||i}),e.jsx("div",{title:"Attach file (image, video, audio, document)",children:e.jsx(C,{variant:"secondary",size:"md",onClick:()=>y.current?.click(),disabled:f||i,className:"flex-shrink-0",children:e.jsx(B,{size:18})})}),e.jsx(A,{placeholder:t?"Add a caption (optional)...":"Type a message...",value:d,onChange:s=>o(s.target.value),disabled:f||i,onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),j())},className:"flex-1"}),e.jsx(C,{variant:"primary",size:"md",onClick:j,disabled:!d&&!t||f||i,className:"flex-shrink-0",children:f||i?e.jsx(V,{size:"sm"}):e.jsx(Y,{size:18})})]}),t&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:[b(t.size)," â€¢ Will be sent at full quality"]})]})}function ge(){W();const[n,r]=m.useState([]),[i,d]=m.useState(!0),[o,t]=m.useState(1),[x,a]=m.useState(1),[u,f]=m.useState(""),[g,v]=m.useState(null),[c,y]=m.useState(null),[k,j]=m.useState([]),[b,s]=m.useState(!1),[p,S]=m.useState(1),[D,$]=m.useState(1);m.useEffect(()=>{F()},[o,u]);const F=async()=>{try{d(!0);const l=await te({page:o,limit:20});r(l.data),a(l.pagination.pages),g&&!l.data.find(h=>h.id===g)&&(v(null),y(null),j([]))}catch(l){N.error(l.message||"Failed to load conversations")}finally{d(!1)}},U=async l=>{try{v(l),s(!0),S(1);const h=await L(l,{page:1,limit:50});y(h.conversation),j(h.messages.reverse()),$(h.pagination.pages),await ae(l)}catch(h){N.error(h.message||"Failed to load conversation"),v(null)}finally{s(!1)}},O=async l=>{if(g)try{s(!0);const h=await L(g,{page:l,limit:50});j(M=>[...h.messages.reverse(),...M]),S(l)}catch(h){N.error(h.message||"Failed to load messages")}finally{s(!1)}},K=async()=>{if(g)try{const l=await L(g,{page:D,limit:50});j(h=>[...h,...l.messages.reverse()]),await F(),N.success("Message sent")}catch(l){N.error(l.message||"Failed to send message")}},q=async(l,h)=>{try{await re(l,h),r(M=>M.map(T=>T.id===l?{...T,status:h}:T)),c?.id===l&&y({...c,status:h}),N.success(`Conversation ${h}`)}catch(M){N.error(M.message||"Failed to update conversation")}};return e.jsx(H,{children:e.jsxs("div",{className:"px-4 md:px-8 py-8 w-full h-full flex flex-col",children:[e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-8",children:[e.jsx("div",{className:"flex items-start justify-between mb-6 flex-wrap gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground mb-2",children:e.jsx("span",{className:"bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Conversations"})}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Members text your church number to start conversations"]})]})}),e.jsx("div",{className:"flex gap-4 items-center",children:e.jsx(A,{type:"text",placeholder:"Search by name or phone...",value:u,onChange:l=>{f(l.target.value),t(1)},className:"flex-1 min-w-xs"})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0",children:[e.jsx(w.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5},className:"lg:col-span-1 flex flex-col min-h-0",children:e.jsxs(z,{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("h2",{className:"font-semibold text-foreground",children:[n.length," Conversations"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx("div",{className:"p-4",children:e.jsx(ne,{conversations:n,selectedConversationId:g||void 0,onSelectConversation:U,onUpdateStatus:q,isLoading:i})})}),x>1&&e.jsxs("div",{className:"p-4 border-t border-border/40 flex justify-between gap-2",children:[e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>t(Math.max(1,o-1)),disabled:o===1,children:"Previous"}),e.jsxs("span",{className:"text-xs text-muted-foreground self-center",children:["Page ",o," of ",x]}),e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>t(Math.min(x,o+1)),disabled:o===x,children:"Next"})]})]})}),e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"lg:col-span-2 flex flex-col min-h-0",children:c?e.jsxs(z,{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-foreground",children:[c.member.firstName," ",c.member.lastName]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c.member.phone})]}),e.jsx("span",{className:`text-xs font-medium px-3 py-1 rounded ${c.status==="open"?"bg-blue-500/20 text-blue-400":c.status==="closed"?"bg-red-500/20 text-red-400":"bg-gray-500/20 text-gray-400"}`,children:c.status})]})}),e.jsx(oe,{conversation:c,messages:k,isLoading:b,page:p,pages:D,onLoadMore:O}),e.jsx(le,{conversationId:c.id,onReply:K})]}):e.jsx(z,{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(I,{className:"w-16 h-16 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the list to view and reply to messages"})]})})})]})]})})}export{ge as ConversationsPage,ge as default};
//# sourceMappingURL=ConversationsPage-Dm-rbdJM.js.map
