import{j as e,m as s}from"./vendor-ui-DhbhiCKM.js";import{a as t,R as a}from"./vendor-react-DC7Nk3dg.js";import{c as r,I as n,S as i,u as o,_ as l}from"./index-D-4OJhHu.js";import{S as d,a as c}from"./SoftLayout-Dwcw0qhz.js";import{S as m}from"./SoftButton-Dr7nJZFM.js";import{t as x,L as u,M as h,D as p,u as f,X as g,v,j,w as b}from"./vendor-utils-C8GUPZyx.js";async function y(e,s={}){const t=new URLSearchParams;s.page&&t.append("page",s.page.toString()),s.limit&&t.append("limit",s.limit.toString());return(await r.get(`/messages/conversations/${e}?${t.toString()}`)).data}const N=t.memo(function({conversation:t,isSelected:a,onSelect:r,onUpdateStatus:n,index:i}){return e.jsx(s.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.05*i},children:e.jsx("button",{onClick:()=>r(t.id),className:"w-full text-left p-4 rounded-lg border transition-all duration-200 "+(a?"border-primary bg-primary/5":"border-border/40 bg-card/50 hover:border-border hover:bg-card"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[t.unreadCount>0&&e.jsx("div",{className:"mt-1 flex-shrink-0",children:e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold text-foreground truncate",children:[t.member.firstName," ",t.member.lastName]}),t.unreadCount>0&&e.jsx("span",{className:"bg-primary/20 text-primary text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0",children:t.unreadCount})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate mb-2",children:t.member.phone}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded ${(e=>{switch(e){case"open":return"bg-blue-500/20 text-blue-400";case"closed":return"bg-red-500/20 text-red-400";case"archived":return"bg-gray-500/20 text-gray-400";default:return"bg-muted text-muted-foreground"}})(t.status)}`,children:t.status}),e.jsx("span",{className:"text-xs text-muted-foreground",children:(e=>{const s=new Date(e),t=new Date,a=(t.getTime()-s.getTime())/36e5;if(a<1){return`${Math.floor((t.getTime()-s.getTime())/6e4)}m ago`}return a<24?`${Math.floor(a)}h ago`:s.toLocaleDateString([],{month:"short",day:"numeric"})})(t.lastMessageAt)})]})]}),a&&n&&e.jsx("div",{className:"flex-shrink-0 flex gap-1",onClick:e=>e.stopPropagation(),children:"archived"!==t.status&&e.jsx(m,{variant:"secondary",size:"sm",onClick:()=>{n(t.id,"archived")},className:"p-2",children:e.jsx(x,{className:"w-4 h-4"})})})]})})})}),{FixedSizeList:w}=require("react-window"),S=a.memo(function({index:s,style:t,data:a}){const{conversations:r,selectedConversationId:n,onSelectConversation:i,onUpdateStatus:o}=a,l=r[s];return e.jsx("div",{style:t,children:e.jsx("div",{className:"px-2",children:e.jsx(N,{conversation:l,isSelected:n===l.id,onSelect:i,onUpdateStatus:o,index:s})})})});function C({conversations:a,selectedConversationId:r,onSelectConversation:n,onUpdateStatus:i,isLoading:o=!1,containerHeight:l=600}){const c=t.useMemo(()=>({conversations:a,selectedConversationId:r,onSelectConversation:n,onUpdateStatus:i}),[a,r,n,i]);return o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(s.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(u,{className:"w-6 h-6 text-primary"})})}):0===a.length?e.jsxs(d,{className:"text-center py-12",children:[e.jsx(h,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No Conversations"}),e.jsx("p",{className:"text-muted-foreground",children:"Conversations will appear here when members text your church number"})]}):e.jsx(w,{height:l,itemCount:a.length,itemSize:88,width:"100%",itemData:c,overscanCount:5,children:S})}const k=a.forwardRef(({src:s,alt:a,fallback:r,onLoad:n,onError:i,className:o,style:l,...d},c)=>{const m=t.useRef(null),[x,u]=t.useState(!1),[h,p]=t.useState(!1);return t.useEffect(()=>{const e=m.current;if(e){if("IntersectionObserver"in window){const t=new IntersectionObserver(a=>{a.forEach(a=>{a.isIntersecting&&(e.src=s,t.unobserve(e),e.onload=()=>{u(!0),n?.()},e.onerror=()=>{p(!0),i?.()})})},{rootMargin:"50px"});return t.observe(e),()=>{t.disconnect()}}e.src=s,u(!0)}},[s,n,i]),e.jsx("img",{ref:m,alt:a,className:`${o||""} ${!x&&r?"blur-sm":""}`,style:{transition:"filter 0.3s ease-in-out",...l},"data-src":s,src:r||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"%3E%3Crect fill="%23f0f0f0" width="400" height="300"/%3E%3C/svg%3E',loading:"lazy",...d})});k.displayName="LazyImage";const z=t.memo(function(s){const{content:t,direction:a,memberName:r,deliveryStatus:n,mediaUrl:i,mediaType:o,mediaName:l,mediaSizeBytes:d,mediaDuration:c,createdAt:m}=s,x="outbound"===a,u=new Date(m).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsx("div",{className:`flex ${x?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:"max-w-sm rounded-lg p-3 "+(x?"bg-primary text-white":"bg-muted text-foreground"),children:[!x&&r&&e.jsx("p",{className:"text-xs font-semibold mb-1 opacity-75",children:r}),i&&"image"===o&&e.jsx("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"block mb-2",children:e.jsx(k,{src:i,alt:"Message attachment",className:"max-w-xs rounded-lg hover:opacity-90 cursor-pointer"})}),i&&"video"===o&&e.jsx("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"block mb-2 relative",children:e.jsxs("video",{className:"max-w-xs rounded-lg",controls:!0,poster:i,children:[e.jsx("source",{src:i,type:"video/mp4"}),"Your browser does not support the video tag."]})}),i&&"audio"===o&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("audio",{controls:!0,className:"max-w-xs rounded-lg",children:[e.jsx("source",{src:i,type:"audio/mpeg"}),"Your browser does not support the audio element."]}),c&&e.jsx("p",{className:"text-xs mt-1 opacity-75",children:(e=>{if(!e)return"";return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`})(c)})]}),i&&"document"===o&&e.jsxs("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 rounded-lg mb-2 "+(x?"bg-white/20 hover:bg-white/30":"bg-foreground/10 hover:bg-foreground/20"),children:[e.jsx("span",{children:"ðŸ“„"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:l}),d&&e.jsx("p",{className:"text-xs opacity-75",children:(e=>{if(!e)return"";const s=e/1024/1024;return s>1?`${s.toFixed(1)}MB`:`${(e/1024).toFixed(0)}KB`})(d)})]}),e.jsx(p,{size:16,className:"flex-shrink-0"})]}),t&&!t.startsWith("[")&&e.jsx("p",{className:"text-sm break-words whitespace-pre-wrap",children:t}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mt-1",children:[e.jsx("p",{className:"text-xs "+(x?"text-white/80":"text-muted-foreground"),children:u}),x&&n&&e.jsxs("span",{className:"text-xs opacity-75",children:["pending"===n&&"â±ï¸","delivered"===n&&"âœ“âœ“","failed"===n&&"âŒ"]})]})]})})});function $({conversation:a,messages:r,isLoading:n=!1,page:i=1,pages:o=1,onLoadMore:l}){const d=t.useRef(null),c=t.useRef(null);return t.useEffect(()=>{i===o&&d.current?.scrollIntoView({behavior:"smooth"})},[r,i,o]),r.length||n?e.jsx("div",{className:"flex flex-col h-full",children:e.jsxs("div",{ref:c,className:"flex-1 overflow-y-auto px-4 py-6 space-y-4",children:[i<o&&e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(m,{variant:"secondary",size:"sm",onClick:()=>l?.(i+1),disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(s.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(u,{className:"w-4 h-4 inline mr-2"})}),"Loading..."]}):"Load Older Messages"})}),r.map(s=>e.jsx(z,{...s},s.id)),n&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(s.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0},children:e.jsx(u,{className:"w-6 h-6 text-primary"})})}),e.jsx("div",{ref:d})]})}):e.jsx("div",{className:"flex flex-col items-center justify-center h-full py-12 text-center",children:e.jsxs("div",{className:"text-muted-foreground",children:[e.jsx("p",{className:"text-lg font-medium mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"This conversation is just getting started. Send a message to get started!"})]})})}function M({conversationId:s,onReply:a,isLoading:r}){const[o,l]=t.useState(""),[d,c]=t.useState(null),[x,u]=t.useState(null),[h,p]=t.useState(!1),[b,y]=t.useState(null),N=t.useRef(null),w=async()=>{if(o||d)if(y(null),d){p(!0);try{const e=new FormData;e.append("file",d),o&&e.append("content",o);const t=await fetch(`/api/messages/conversations/${s}/reply-with-media`,{method:"POST",body:e});if(!t.ok){const e=await t.json();throw new Error(e.error||"Failed to send message with media")}l(""),c(null),u(null),N.current&&(N.current.value=""),await a("")}catch(e){y(e instanceof Error?e.message:"Failed to send media")}finally{p(!1)}}else try{const e=await fetch(`/api/messages/conversations/${s}/reply`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:o})});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to send message")}l(""),await a("")}catch(e){y(e instanceof Error?e.message:"Failed to send message")}};return e.jsxs("div",{className:"bg-card border-t border-border p-4",children:[b&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-3 bg-red-500/10 text-red-600 rounded-lg",children:[e.jsx(f,{size:16,className:"flex-shrink-0"}),e.jsx("p",{className:"text-sm",children:b}),e.jsx("button",{onClick:()=>y(null),className:"ml-auto text-red-600 hover:text-red-700",children:e.jsx(g,{size:16})})]}),x&&e.jsxs("div",{className:"mb-3 relative inline-block",children:[e.jsx("img",{src:x,alt:"Preview",className:"max-h-40 rounded-lg border border-border"}),e.jsx("button",{onClick:()=>{c(null),u(null),N.current&&(N.current.value="")},className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(g,{size:16})})]}),d&&!x&&e.jsxs("div",{className:"mb-3 flex items-center gap-2 p-2 bg-muted rounded-lg",children:[e.jsx(v,{size:16,className:"text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm text-foreground flex-1 truncate",children:d.name}),e.jsx("button",{onClick:()=>{c(null),N.current&&(N.current.value="")},className:"text-red-500 hover:text-red-600 flex-shrink-0",children:e.jsx(g,{size:16})})]}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("input",{ref:N,type:"file",onChange:async e=>{const s=e.target.files?.[0];if(!s)return;y(null);if(s.size>524288e3)return void y(`File too large. Max 500MB, got ${(s.size/1024/1024).toFixed(1)}MB`);if(["image/jpeg","image/png","image/gif","image/webp","video/mp4","video/quicktime","video/x-msvideo","video/x-matroska","audio/mpeg","audio/wav","audio/aac","audio/ogg","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(s.type))if(c(s),s.type.startsWith("image/")){const e=new FileReader;e.onload=e=>{u(e.target?.result)},e.readAsDataURL(s)}else u(null);else y(`File type not allowed: ${s.type}`)},style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx",disabled:h||r}),e.jsx("div",{title:"Attach file (image, video, audio, document)",children:e.jsx(m,{variant:"secondary",size:"md",onClick:()=>N.current?.click(),disabled:h||r,className:"flex-shrink-0",children:e.jsx(v,{size:18})})}),e.jsx(n,{placeholder:d?"Add a caption (optional)...":"Type a message...",value:o,onChange:e=>l(e.target.value),disabled:h||r,onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),w())},className:"flex-1"}),e.jsx(m,{variant:"primary",size:"md",onClick:w,disabled:!o&&!d||h||r,className:"flex-shrink-0",children:h||r?e.jsx(i,{size:"sm"}):e.jsx(j,{size:18})})]}),d&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:[(e=>{if(!e)return"";const s=e/1024/1024;return s>1?`${s.toFixed(1)}MB`:`${(e/1024).toFixed(0)}KB`})(d.size)," â€¢ Will be sent at full quality"]})]})}function F(){o();const[a,i]=t.useState([]),[x,u]=t.useState(!0),[p,f]=t.useState(1),[g,v]=t.useState(1),[j,N]=t.useState(""),[w,S]=t.useState(null),[k,z]=t.useState(null),[F,L]=t.useState([]),[E,I]=t.useState(!1),[R,T]=t.useState(1),[D,U]=t.useState(1);t.useEffect(()=>{B()},[p,j]);const B=async()=>{try{u(!0);const e=await async function(e={}){const s=new URLSearchParams;return e.page&&s.append("page",e.page.toString()),e.limit&&s.append("limit",e.limit.toString()),e.status&&s.append("status",e.status),(await r.get(`/messages/conversations?${s.toString()}`)).data}({page:p,limit:20});i(e.data),v(e.pagination.pages),w&&!e.data.find(e=>e.id===w)&&(S(null),z(null),L([]))}catch(e){l.error(e.message||"Failed to load conversations")}finally{u(!1)}};return e.jsx(c,{children:e.jsxs("div",{className:"px-4 md:px-8 py-8 w-full h-full flex flex-col",children:[e.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-8",children:[e.jsx("div",{className:"flex items-start justify-between mb-6 flex-wrap gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground mb-2",children:e.jsx("span",{className:"bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Conversations"})}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(b,{className:"w-4 h-4"}),"Members text your church number to start conversations"]})]})}),e.jsx("div",{className:"flex gap-4 items-center",children:e.jsx(n,{type:"text",placeholder:"Search by name or phone...",value:j,onChange:e=>{N(e.target.value),f(1)},className:"flex-1 min-w-xs"})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0",children:[e.jsx(s.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5},className:"lg:col-span-1 flex flex-col min-h-0",children:e.jsxs(d,{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("h2",{className:"font-semibold text-foreground",children:[a.length," Conversations"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:0!==a.length||x?e.jsx("div",{className:"p-4",children:e.jsx(C,{conversations:a,selectedConversationId:w||void 0,onSelectConversation:async e=>{try{S(e),I(!0),T(1);const s=await y(e,{page:1,limit:50});z(s.conversation),L(s.messages.reverse()),U(s.pagination.pages),await async function(e){await r.patch(`/messages/conversations/${e}/read`)}(e)}catch(s){l.error(s.message||"Failed to load conversation"),S(null)}finally{I(!1)}},onUpdateStatus:async(e,s)=>{try{await async function(e,s){return(await r.patch(`/messages/conversations/${e}/status`,{status:s})).data}(e,s),i(t=>t.map(t=>t.id===e?{...t,status:s}:t)),k?.id===e&&z({...k,status:s}),l.success(`Conversation ${s}`)}catch(t){l.error(t.message||"Failed to update conversation")}},isLoading:x})}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(h,{className:"w-16 h-16 text-muted-foreground/40 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No Conversations Yet"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Members who text your church number will appear here. Share your church number to get started!"})]})}),g>1&&e.jsxs("div",{className:"p-4 border-t border-border/40 flex justify-between gap-2",children:[e.jsx(m,{variant:"secondary",size:"sm",onClick:()=>f(Math.max(1,p-1)),disabled:1===p,children:"Previous"}),e.jsxs("span",{className:"text-xs text-muted-foreground self-center",children:["Page ",p," of ",g]}),e.jsx(m,{variant:"secondary",size:"sm",onClick:()=>f(Math.min(g,p+1)),disabled:p===g,children:"Next"})]})]})}),e.jsx(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"lg:col-span-2 flex flex-col min-h-0",children:k?e.jsxs(d,{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-border/40",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-foreground",children:[k.member.firstName," ",k.member.lastName]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:k.member.phone})]}),e.jsx("span",{className:"text-xs font-medium px-3 py-1 rounded "+("open"===k.status?"bg-blue-500/20 text-blue-400":"closed"===k.status?"bg-red-500/20 text-red-400":"bg-gray-500/20 text-gray-400"),children:k.status})]})}),e.jsx($,{conversation:k,messages:F,isLoading:E,page:R,pages:D,onLoadMore:async e=>{if(w)try{I(!0);const s=await y(w,{page:e,limit:50});L(e=>[...s.messages.reverse(),...e]),T(e)}catch(s){l.error(s.message||"Failed to load messages")}finally{I(!1)}}}),e.jsx(M,{conversationId:k.id,onReply:async()=>{if(w)try{const e=await y(w,{page:D,limit:50});L(s=>[...s,...e.messages.reverse()]),await B(),l.success("Message sent")}catch(e){l.error(e.message||"Failed to send message")}}})]}):e.jsx(d,{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(h,{className:"w-16 h-16 text-muted-foreground/50 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the list to view and reply to messages"})]})})})]})]})})}export{F as ConversationsPage,F as default};
